<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-108646205-1', 'auto');
ga('send', 'pageview');

</script>

  
  <title>験なきものを思はずは</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <meta name="google-site-verification" content="6BVUUhfChBaBuvPT_Bt0TjOGRaY58Ym-h0x9b9_M1uU">
  <meta property="og:type" content="website">
<meta property="og:title" content="験なきものを思はずは">
<meta property="og:url" content="https://azriton.github.io/page/8/index.html">
<meta property="og:site_name" content="験なきものを思はずは">
<meta property="og:locale" content="ja">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="験なきものを思はずは">
<meta name="twitter:creator" content="@azriton">
  
    <link rel="alternate" href="/atom.xml" title="験なきものを思はずは" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
  
  <link href="//fonts.googleapis.com/css?family=Lato" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">



<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-4479317936085716",
          enable_page_level_ads: true
     });
</script>



<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner" style="filter:brightness(74%)"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">験なきものを思はずは</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Azriton&#39;s blog</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link Home" href="/">Home</a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-github-link" class="nav-icon" href="https://github.com/azriton" title="GitHub"></a>
        <a id="nav-twitter-link" class="nav-icon" href="https://twitter.com/azriton" title="Twitter"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSSフィード"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="検索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://azriton.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Windows7でOpenSSLを使えるようにする" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/27/Windows7でOpenSSLを使えるようにする/" class="article-date">
  <time datetime="2017-01-26T15:00:00.000Z" itemprop="datePublished">2017-01-27</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/開発環境/">開発環境</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2017/01/27/Windows7でOpenSSLを使えるようにする/">Windows 7 で OpenSSL を 使えるようにする</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/openssl/openssl.png" alt title="OpenSSL"></p>
<p>ちょっと OpenSSL が 必要なことってありませんか？(いや、そうそう無いか…)<br>普段使用している環境は Windows で、OpenSSL を 簡単に使うことができません. ちょうど OpenSSL が 必要な困った事案が発生、また環境構築にはまったので記録を残しておきたいと思います.</p>
<p><strong>作業環境</strong></p>
<ul>
<li>Windows 7 64bit</li>
<li>Microsoft Windows SDK v7.1</li>
<li>Strawberry Perl 5.24.0.1 64bit</li>
<li>OpenSSL 1.0.2j LTS</li>
</ul>
<h2 id="ビルド環境の準備"><a href="#ビルド環境の準備" class="headerlink" title="ビルド環境の準備"></a>ビルド環境の準備</h2><p>OpenSSL は バイナリを配布していません. 自分でビルドしないと使えません. インターネットは広いので<a href="https://www.openssl.org/community/binaries.html" target="_blank" rel="noopener">親切な方がビルドしたものを配布</a>してくれていますが、今回は自前でビルドする環境を用意したいと思います.</p>
<h3 id="C-コンパイラ-の-用意"><a href="#C-コンパイラ-の-用意" class="headerlink" title="C++ コンパイラ の 用意"></a>C++ コンパイラ の 用意</h3><p>まず C++ の コンパイラが必要です. “April 2005 Platform SDK is equipped – OpenSSL/INSTALL.W64” と なっていますが、”<a href="https://blogs.msdn.microsoft.com/japan_platform_sdkwindows_sdk_support_team_blog/2011/04/21/windows-sdk/" target="_blank" rel="noopener">古い SDK が必要な場合は、以下の MSDN サブスクリプションのダウンロードをご検討ください – JAPAN Platform SDK（Windows SDK） Support Team Blog</a>“ とのことで、有償です…<br>というか、ちゃんと現在の OS に 合わせた SDK を 使う必要があるので、Windows 7 の SDK を 取ってきます.<br>こちらから <a href="https://www.microsoft.com/en-us/download/details.aspx?id=8279" target="_blank" rel="noopener">Microsoft Windows SDK for Windows 7 and .NET Framework 4
</a>からダウンロードしてインストールします.<br>最低限のインストール・オプション は 以下となります.</p>
<ul>
<li>Windows Headers and Libraries</li>
<li>Visual C++ Compilers</li>
<li>Microsoft Visual C++ 2010 (Redistributable)<br><img src="/assets/openssl/01.png" alt></li>
</ul>
<h3 id="Perl-の-用意"><a href="#Perl-の-用意" class="headerlink" title="Perl の 用意"></a>Perl の 用意</h3><p>続いて、Perl が 必要となります. これまた Windows ユーザ としては困るところです…<br>ドキュメントでは “You can run under Cygwin or you can download<br> ActiveState Perl – OpenSSL/INSTALL.W64” となっています. [ActivePerl(<a href="http://www.activestate.com/activeperl)]" target="_blank" rel="noopener">http://www.activestate.com/activeperl)]</a> は 沢山お世話になり今回もお世話になるところですが、最近は <a href="http://strawberryperl.com/" target="_blank" rel="noopener">Strawberry Perl</a> なるものもあるようです.</p>
<p><code>cpan</code> や <code>ppm</code> などの 違いがあったりするようですが、今回 Strawberry Perl を 選択したのは、PortableZIP edition が あったからになります.<br>OpenSSL の <code>Configure</code> を 実行したいだけなので、Zip を 解凍するだけで使えるはとてもありがたいです. できればインストーラであれこれ入れてほしくないし、フォルダの削除だけで全て無かったことにできるのは助かります. ということで、Strawberry Perl で 行きます.</p>
<p>ウェブサイトからダウンロードして解凍して終了です.<br>今回は <code>C:\Develop\sdk\strawberry-perl-5.24.0.1-64bit-portable</code> に 解凍したものとします. README.txt に 書かれていますが、スペースや日本語が含まれないディレクトリにするとのことです.</p>
<p><em>参考情報</em><br>Perl の 選択肢については、以下のサイトを参考にさせて頂きました. すばらしい情報ありがとうございます！</p>
<ul>
<li><a href="http://perl-users.jp/articles/advent-calendar/2010/win32/1" target="_blank" rel="noopener">Windows で Perl をはじめよう！ - JPerl Advent Calendar 2010 Win32 Track</a></li>
<li><a href="http://www.nwt.jp/document/strawberryperl.php" target="_blank" rel="noopener">ActivePerl以外の選択肢 - StrawberryPerlを使う - Network Tactics</a></li>
</ul>
<h2 id="OpenSSL-を-ビルド"><a href="#OpenSSL-を-ビルド" class="headerlink" title="OpenSSL を ビルド"></a>OpenSSL を ビルド</h2><p>OpenSSL の ソース を ダウンロードします. <a href="https://www.openssl.org/" target="_blank" rel="noopener">OpenSSL の ウェブサイト</a> から取得しますが、Web サーバ で 使うわけではないので、安定版ということで 今回は LTS(Long Term Support) の   openssl-1.0.2j.tar.gz を 選択しました.</p>
<p>ダウンロードしたアーカイブを解凍します.<br>今回は <code>C:\Develop\tool\openssl-1.0.2j</code> に 解凍したものとします.</p>
<p>続いて <code>Windows SDK 7.1 Command Prompt</code> を 起動します. (通常 の コマンド プロンプト ではないことに注意)<br><img src="/assets/openssl/02.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre><td class="code"><pre><span class="line">c:\Develop\tool\openssl-1.0.2j&gt; set PATH=%PATH%;c:\Develop\sdk\strawberry-perl-5.24.0.1-64bit-portable\perl\bin</span><br><span class="line">c:\Develop\tool\openssl-1.0.2j&gt; perl Configure VC-WIN64A</span><br><span class="line">c:\Develop\tool\openssl-1.0.2j&gt; ms\do_win64a</span><br><span class="line">c:\Develop\tool\openssl-1.0.2j&gt; nmake -f ms\ntdll.mak</span><br><span class="line">c:\Develop\tool\openssl-1.0.2j&gt; cd out32dll</span><br><span class="line">c:\Develop\tool\openssl-1.0.2j&gt; ..\ms\test</span><br><span class="line">...(省略)</span><br><span class="line">passed all tests</span><br><span class="line"></span><br><span class="line">c:\Develop\sdk\openssl-1.0.2j\out32dll&gt;openssl version</span><br><span class="line">OpenSSL 1.0.2j  26 Sep 2016</span><br></pre></table></figure>
<p>無事、ビルドできました！</p>
<h2 id="鍵生成-や-自己署名証明書発行-の-テスト"><a href="#鍵生成-や-自己署名証明書発行-の-テスト" class="headerlink" title="鍵生成 や 自己署名証明書発行 の テスト"></a>鍵生成 や 自己署名証明書発行 の テスト</h2><p>OpenSSL の 利用にあたっては、通常 の コマンド プロンプト で 大丈夫です.<br>実行に当たっては環境変数の設定が必要なものがあったりしますので注意が必要です. (ちゃんとインストールしようよということでもあるのですが、ちょっと使うだけだから… と 言い訳してみる)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre><td class="code"><pre><span class="line">c:\Temp&gt; set PATH=%PATH%;c:\Develop\tool\openssl-1.0.2j\out32dll</span><br><span class="line"></span><br><span class="line">c:\Temp&gt; set RANDFILE=%TEMP%\.rnd</span><br><span class="line">c:\Temp&gt; set OPENSSL_CONF=c:\Develop\tool\openssl-1.0.2j\apps\openssl.cnf</span><br><span class="line"></span><br><span class="line">c:\Temp&gt; openssl genrsa -aes256</span><br><span class="line"></span><br><span class="line">c:\Temp&gt; openssl genrsa -out test.key 4096</span><br><span class="line">c:\Temp&gt; openssl req -x509 -new -key test.key -out test.pem</span><br></pre></table></figure></p>
<h2 id="はまったところ"><a href="#はまったところ" class="headerlink" title="はまったところ"></a>はまったところ</h2><h3 id="Visual-C-Compilers-が-選択できない"><a href="#Visual-C-Compilers-が-選択できない" class="headerlink" title="Visual C++ Compilers が 選択できない"></a>Visual C++ Compilers が 選択できない</h3><p>.NET 4 (4.x ではなく <strong>4</strong>) が 必要になります. しかも、新しいバージョンが入っているとインストールできないというトラップがありました… 新しいバージョンが入っている場合はアンインストールして、古いバージョンから順番に入れなおす必要があります.<br>.NET の バージョンについては、こちら <a href="http://www.atmarkit.co.jp/ait/articles/1211/16/news093.html" target="_blank" rel="noopener">Tech TIPS：.NET Frameworkのバージョンを整理する - ＠IT</a> が 詳しいです.<br><img src="/assets/openssl/03.png" alt><br><img src="/assets/openssl/04.png" alt></p>
<h3 id="インストーラは正常終了しているのに、インストールされていない"><a href="#インストーラは正常終了しているのに、インストールされていない" class="headerlink" title="インストーラは正常終了しているのに、インストールされていない"></a>インストーラは正常終了しているのに、インストールされていない</h3><p>何が起こったのかよくわからない事象で、見事にどはまりしました orz<br>インストーラは正常終了したように見えているのに、肝心のプログラムが入っていない状況が起こりました. 1 GB の インストールにしては、やたら早く終わったなぁというのが気になったぐらいです.<br><img src="/assets/openssl/05.png" alt></p>
<p>どうやら、こちら <a href="http://www.projectgroup.info/tips/Others/comm_0004.html" target="_blank" rel="noopener">Windows SDK for Windows 7.1 をインストールするとエラーが発生する - Windows - Project Group</a> の 現象だったようです. “A problem occurred…” なんて表示されなかったようにも思いますが、色が付いているわけでもないので…<br>上記サイトの情報をもとに、Microsoft Visual C++ 2010 x64/x86 Redistributable を 確認したところ、見事に x64 の方が入っていました. アンインストールしてから再度 SDK を 入れたところ、無事にインストールができました. こちらのサイトの情報がなかったら完全にアウトだったかもしれません. 助かりました. 有益な情報ありがとうございます！<br><img src="/assets/openssl/06.png" alt></p>
<hr>
<p>いろいろと難所はありましたが、無事に OpenSSL を Windows に 入れることができました.<br>Windows 10 の Bash on Ubuntu on Windows なら、こんな苦労をしなくても良いのかなぁと思いつつも、まだまだ Windows 7 を 使うのでした…</p>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2017/01/27/Windows7でOpenSSLを使えるようにする/" data-id="ckq2rxv9u001444r2wzkopltb" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/">Windows</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/09/13/Gitの全体gitignoreを再設定する/" title="Git の 全体 gitignore を 再設定する" rel="bookmark">Git の 全体 gitignore を 再設定する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/11/25/Windowsのプロキシを自動設定するタスクを作成/" title="Windows の プロキシ を 自動設定するタスクを作成" rel="bookmark">Windows の プロキシ を 自動設定するタスクを作成</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
    <article id="post-Slackのボットで今日の天気を通知する-JSON取得編" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/24/Slackのボットで今日の天気を通知する-JSON取得編/" class="article-date">
  <time datetime="2017-01-23T15:00:00.000Z" itemprop="datePublished">2017-01-24</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/ボット/">ボット</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2017/01/24/Slackのボットで今日の天気を通知する-JSON取得編/">Slack の ボット で 今日の天気を通知する - JSON 取得編</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/slack/slack.png" alt title="Slack"></p>
<p>ボットを使って、Slack に 今日の天気を通知してもらうようにしたいと思います.<br>天気関連はいろいろなサービスがあり、それを使うのも手なのですが自分でカスタマイズした細かいところにこだわったツールにしたいと思うので、ボットに教えてもらうことにします.</p>
<p><strong>作業環境</strong></p>
<ul>
<li>Node.js 6.9.1 LTS</li>
</ul>
<h2 id="天気の情報を提供してくれるサービス"><a href="#天気の情報を提供してくれるサービス" class="headerlink" title="天気の情報を提供してくれるサービス"></a>天気の情報を提供してくれるサービス</h2><p>今回は <a href="http://openweathermap.org/" target="_blank" rel="noopener">OpenWeatherMap</a> の API を 使って情報を取得したいと思います.<br><a href="https://ja.wikipedia.org/wiki/Openweathermap" target="_blank" rel="noopener">Openweathermap - Wikipedia</a> によると、OpenWeatherMap は 各種気象データを 無料 で API 提供してくれるサービスとのことです. しかも全データは、<a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">CC BY-SA</a> に 準じるとのことで、情報の改変や商用利用が許可されています. ありがたい！<br>※ OpenWeatherMap の ToS は こちら <a href="http://openweathermap.org/terms" target="_blank" rel="noopener">Terms of Service</a></p>
<p>無料で利用できますが、主な利用条件は以下となります.</p>
<ul>
<li>1分間 の API 呼び出し回数は 60回</li>
<li>現在の天気 に 加え、3時間ごと 5日間の予報が使える</li>
<li>天気情報の更新 は <strong>2時間以内</strong><br>※ 情報の更新について、Wikipedia に 10分以内となってますが、10分以内は Pro 以上で、Free は 2時間以内となっている<br><img src="/assets/slack/weather/01.png" alt></li>
</ul>
<p><em>参考情報</em><br>天気情報が提供されているサービスについては、こちらのサイトを参考にさせて頂きました. 素晴らしい情報 ありがとうございます！</p>
<ul>
<li><a href="http://illarena.com/programming/webapi/openweathermap/webapi_tenki/" target="_blank" rel="noopener">【WebAPI】天気予報等の気象情報を提供するWebAPIについての概要 | illarena</a></li>
</ul>
<h2 id="API-キー-の-取得"><a href="#API-キー-の-取得" class="headerlink" title="API キー の 取得"></a>API キー の 取得</h2><p>OpenWeatherMap の Sing Up サイト <a href="https://home.openweathermap.org/users/sign_up" target="_blank" rel="noopener">https://home.openweathermap.org/users/sign_up</a> へ アクセスします.<br>全ての項目を入力、ToS/PP を 確認し同意したら <code>I agree ~~~</code> に チェックして、[Create Account] ボタンをクリックします.<br><img src="/assets/slack/weather/02.png" alt></p>
<p>利用目的を聞かれるので、法人利用の場合は [Company] も 入力し、[Purpose] を 選択します.<br><img src="/assets/slack/weather/03.png" alt></p>
<p>無事、API キー が 発行されました.<br>Welcome メール は 届きますが URL クリックによる認証などがなく、簡単にサインアップさせてくれるので助かります.<br><img src="/assets/slack/weather/04.png" alt></p>
<h2 id="現在の天気情報を取得する"><a href="#現在の天気情報を取得する" class="headerlink" title="現在の天気情報を取得する"></a>現在の天気情報を取得する</h2><p>Botkit に 組み込むので、Node.js で コーディングします.<br>※ [API_KEY] を 上記で取得した API キー に 置き換えます.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line">http.get(<span class="string">"http://api.openweathermap.org/data/2.5/weather?id=1850147&amp;units=metric&amp;appid=[API_KEY]"</span>, (response) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> buffer = <span class="string">''</span>;</span><br><span class="line">    response.setEncoding(<span class="string">'utf8'</span>).on(<span class="string">'data'</span>, (chunk) =&gt; &#123;  buffer += chunk;  &#125;);</span><br><span class="line">    response.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> current = <span class="built_in">JSON</span>.parse(buffer);</span><br><span class="line">        <span class="built_in">console</span>.log(current)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></table></figure></p>
<p>HTTP GET で 取得して、JSON 出力をする簡単なものになります. 特別な実装部分はありません.<br>URL の パラメーターは以下となります.</p>
<ul>
<li><code>id=1850147</code> は、天気情報を取得する 都市 の ID (今回は東京、ID の 取得は後述)</li>
<li><code>units=metric</code> は、摂氏華氏(°C/°F) を気温を摂氏にするために指定 (デフォルトは華氏)</li>
<li><code>appid=[API_KEY]</code> で、API キーを指定</li>
</ul>
<p>実行すると以下のような JSON が 出力されます.<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre><td class="code"><pre><span class="line">&#123; coord: &#123; lon: 139.69, lat: 35.69 &#125;,</span><br><span class="line">  weather:</span><br><span class="line">   [ &#123; id: 801,</span><br><span class="line">       main: 'Clouds',</span><br><span class="line">       description: 'few clouds',</span><br><span class="line">       icon: '02d' &#125; ],</span><br><span class="line">  base: 'stations',</span><br><span class="line">  main:</span><br><span class="line">   &#123; temp: 6.85,</span><br><span class="line">     pressure: 1019.67,</span><br><span class="line">     humidity: 80,</span><br><span class="line">     temp_min: 6.85,</span><br><span class="line">     temp_max: 6.85,</span><br><span class="line">     sea_level: 1023.45,</span><br><span class="line">     grnd_level: 1019.67 &#125;,</span><br><span class="line">  wind: &#123; speed: 2.96, deg: 2.5058 &#125;,</span><br><span class="line">  clouds: &#123; all: 12 &#125;,</span><br><span class="line">  dt: 1485145194,</span><br><span class="line">  sys:</span><br><span class="line">   &#123; message: 0.0063,</span><br><span class="line">     country: 'JP',</span><br><span class="line">     sunrise: 1485121634,</span><br><span class="line">     sunset: 1485158355 &#125;,</span><br><span class="line">  id: 1850147,</span><br><span class="line">  name: 'Tokyo',</span><br><span class="line">  cod: 200 &#125;</span><br></pre></table></figure></p>
<p>天気は、<code>weather[0].main</code> に なります. なぜ weather が 配列なのかはちょっとわかりませんが…<br>なお、今回の例では <code>Clouds</code> なので曇りです.<br>JSON の 内容については、次回にしたいと思います.<br>※ OpenWeatherMap の 現在の天気 API 仕様 は こちら、<a href="http://openweathermap.org/current" target="_blank" rel="noopener">Current weather data</a></p>
<h2 id="3時間ごと-5日間-の-天気予報を取得"><a href="#3時間ごと-5日間-の-天気予報を取得" class="headerlink" title="3時間ごと 5日間 の 天気予報を取得"></a>3時間ごと 5日間 の 天気予報を取得</h2><p>先の実装と変わるのは URL の パス が <code>/weather</code> から <code>/forecast</code> に なる点です.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line">http.get(<span class="string">"http://api.openweathermap.org/data/2.5/forecast?id=1850147&amp;units=metric&amp;appid=[API_KEY]"</span>, (response) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> buffer = <span class="string">''</span>;</span><br><span class="line">    response.setEncoding(<span class="string">'utf8'</span>).on(<span class="string">'data'</span>, (chunk) =&gt; &#123;  buffer += chunk;  &#125;);</span><br><span class="line">    response.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> forecast = <span class="built_in">JSON</span>.parse(buffer);</span><br><span class="line">        <span class="built_in">console</span>.log(forecast)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></table></figure></p>
<p>実行すると以下のような JSON が 出力されます.<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre><td class="code"><pre><span class="line">&#123; city:</span><br><span class="line">   &#123; id: 1850147,</span><br><span class="line">     name: 'Tokyo',</span><br><span class="line">     coord: &#123; lon: 139.691711, lat: 35.689499 &#125;,</span><br><span class="line">     country: 'JP',</span><br><span class="line">     population: 0,</span><br><span class="line">     sys: &#123; population: 0 &#125; &#125;,</span><br><span class="line">  cod: '200',</span><br><span class="line">  message: 0.0147,</span><br><span class="line">  cnt: 38,</span><br><span class="line">  list:</span><br><span class="line">   [ &#123; dt: 1485151200,</span><br><span class="line">       main:</span><br><span class="line">        &#123; temp: 6.12,</span><br><span class="line">          temp_min: 6.12,</span><br><span class="line">          temp_max: 6.12,</span><br><span class="line">          pressure: 1022.42,</span><br><span class="line">          sea_level: 1023.53,</span><br><span class="line">          grnd_level: 1022.42,</span><br><span class="line">          humidity: 59,</span><br><span class="line">          temp_kf: 0 &#125;,</span><br><span class="line">       weather:</span><br><span class="line">        [ &#123; id: 802,</span><br><span class="line">            main: 'Clouds',</span><br><span class="line">            description: 'scattered clouds',</span><br><span class="line">            icon: '03d' &#125; ],</span><br><span class="line">       clouds: &#123; all: 36 &#125;,</span><br><span class="line">       wind: &#123; speed: 7.62, deg: 319.001 &#125;,</span><br><span class="line">       sys: &#123; pod: 'd' &#125;,</span><br><span class="line">       dt_txt: '2017-01-23 06:00:00' &#125;,</span><br><span class="line">     &#123; ... (3時間ごとの繰り返し) &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></table></figure></p>
<p>天気は、予報 38回分なのでリスト <code>list</code> に 入っています. その中の構造は現在の天気とほぼ同じです.<br>直近の予報を取得するには <code>list[0].weather[0].main</code> に なります. 今回の例では <code>Clouds</code> なので曇りです.<br>※ OpenWeatherMap の 天気予報 API 仕様 は こちら、<a href="http://openweathermap.org/forecast5" target="_blank" rel="noopener">5 day weather forecast</a></p>
<h2 id="都市-ID-の-取得方法-と-他の検索方法-について"><a href="#都市-ID-の-取得方法-と-他の検索方法-について" class="headerlink" title="都市 ID の 取得方法 と 他の検索方法 について"></a>都市 ID の 取得方法 と 他の検索方法 について</h2><p>OpenWeatherMap の 天気情報および予報について、取得する都市や地域の指定は以下の 4種類で指定できます.</p>
<table>
<thead>
<tr>
<th style="text-align:left">指定方法
<th style="text-align:left">　クエリ例
<th style="text-align:left">概要


<tbody>
<tr>
<td style="text-align:left">都市名
<td style="text-align:left">　<a href="http://openweathermap.org/find?q=tokyo,jp" target="_blank" rel="noopener">q=tokyo,jp</a>
<td style="text-align:left">都道府県以下は曖昧になり意図とは異なる場合も.

<tr>
<td style="text-align:left">都市 ID
<td style="text-align:left">　<a href="http://openweathermap.org/city/1850147" target="_blank" rel="noopener">id=1850147</a>
<td style="text-align:left">OpenWeatherMap の ID 指定. 確実！

<tr>
<td style="text-align:left">地理座標
<td style="text-align:left">　<a href="http://openweathermap.org/weathermap?lat=35.69&amp;lon=139.69#" target="_blank" rel="noopener">lat=35.69&amp;lon=139.69</a>
<td style="text-align:left">明確な指定方法と思われるが緯度経度を調べるのが大変…

<tr>
<td style="text-align:left">郵便番号
<td style="text-align:left">　zip=1000005,jp
<td style="text-align:left">これも明確な指定方法と思われる


</table>
<p>いろいろな方法がありますが当然のことながら、すべての都市や緯度経度に天気観測のステーションがあるわけではなく、近隣のステーション情報へのマッピングがされていると考えると、都市 ID が 一番確実だと考え、今回は 都市 ID で 指定するようにしました.</p>
<p>また、公式にも “We recommend to call API by city ID to get unambiguous result for your city. – <a href="http://openweathermap.org/current#cityid" target="_blank" rel="noopener">OpenWeatherMap</a>“ と 謳われているので、都市 ID で 指定したほうがよいのでしょう.</p>
<p>都市 ID は <a href="http://bulk.openweathermap.org/sample/" target="_blank" rel="noopener">http://bulk.openweathermap.org/sample/</a> から取得します.<br><img src="/assets/slack/weather/05.png" alt></p>
<p><code>city.list.json.gz</code> が 都市情報のデータになります.<br>全世界の都市データが入っており、2017年1月現在で 全 209,578 件 で、<code>&quot;country&quot;:&quot;JP&quot;</code> でも 1,402件です. すごい.<br>そして、なぜか、<code>御影</code> <code>芦屋</code> <code>松山市</code> は 漢字で都市名が入っている. なぜだろう…</p>
<p>以下に 日本 と 東京、<code>御影</code>、<code>芦屋</code>、<code>松山市</code> を 抜粋し、Google マップ による緯度経度検索結果の場所を載せておきます.<br><code>_id</code> の 値が 都市 ID になります. (実際はスペースなし、投稿用に整形済み)<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre><td class="code"><pre><span class="line">&#123; "_id": 1861060, "name": "Japan",         "country": "JP", "coord": &#123; "lon": 139.753098, "lat": 35.68536  &#125;&#125;  // 皇居</span><br><span class="line">&#123; "_id": 1850147, "name": "Tokyo",         "country": "JP", "coord": &#123; "lon": 139.691711, "lat": 35.689499 &#125;&#125;  // 東京都庁</span><br><span class="line">&#123; "_id": 1850144, "name": "Tōkyō-to",      "country": "JP", "coord": &#123; "lon": 139.691711, "lat": 35.689499 &#125;&#125;  // 東京都庁</span><br><span class="line">&#123; "_id": 1864529, "name": "Chiyoda-ku",    "country": "JP", "coord": &#123; "lon": 139.753632, "lat": 35.694019 &#125;&#125;  // 千代田区役所</span><br><span class="line">&#123; "_id": 7302982, "name": "御影",          "country": "JP", "coord": &#123; "lon": 135.252426, "lat": 34.724258 &#125;&#125;  // 阪急 御影駅？</span><br><span class="line">&#123; "_id": 7302983, "name": "芦屋",          "country": "JP", "coord": &#123; "lon": 135.30719,  "lat": 34.733921 &#125;&#125;  // ＪＲ 芦屋駅？</span><br><span class="line">&#123; "_id": 1864985, "name": "Ashiya",        "country": "JP", "coord": &#123; "lon": 135.302643, "lat": 34.728069 &#125;&#125;  // 阪急 芦屋駅？</span><br><span class="line">&#123; "_id": 7303001, "name": "松山市",        "country": "JP", "coord": &#123; "lon": 132.756729, "lat": 33.83905  &#125;&#125;  // 松山市内？</span><br><span class="line">&#123; "_id": 1926099, "name": "Matsuyama-shi", "country": "JP", "coord": &#123; "lon": 132.765747, "lat": 33.839161 &#125;&#125;  // 松山市役所</span><br></pre></table></figure></p>
<hr>
<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51SYfM4adrL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">はじめてみようSlack 使いこなすための31のヒント</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">Slack研究会 パーソナルメディア 2016-08-03    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01L7HCBT2%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14364488%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>            <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-89-362326-3%2520%257C%25204-893-62326-3%2520%257C%25204-8936-2326-3%2520%257C%25204-89362-326-3%2520%257C%25204-893623-26-3%2520%257C%25204-8936232-6-3" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>

<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51g9K9r7quL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Slack入門 [ChatOpsによるチーム開発の効率化]</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">松下 雅和,小島 泰洋,長瀬 敦史,坂本 卓巳 技術評論社 2016-06-28    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01HI2TD28%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14263497%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>           <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-77-418238-4%2520%257C%25204-774-18238-4%2520%257C%25204-7741-8238-4%2520%257C%25204-77418-238-4%2520%257C%25204-774182-38-4%2520%257C%25204-7741823-8-4" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>



<hr>
<p>簡単に利用できる API を 無料で公開してくれるサービスのおかげで、容易に天気情報が取得できました. 毎朝の天気を Slack に 流すだけなら、もう Botkit に 組み込めそうですが、取得できたデータをしっかり把握したいので、次回は JSON の 内容について確認したいと思います.<br><a href="/2017/01/12/Slackのボットで定時アクション/">Slack の ボットで定時アクション</a> が できるようになったところで、定番の天気予報に入らず <a href="/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/">Slack の ボット で JRA 競馬 の 開催日を通知</a> と いきなり脱線しましたが、軌道修正して基本の天気予報を流せるようにしていきたいと思います.</p>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2017/01/24/Slackのボットで今日の天気を通知する-JSON取得編/" data-id="ckq2rxvd300a044r2e2w5bflp" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Botkit/">Botkit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Slack/">Slack</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/02/10/Slackのボットで定期的に降水予報を通知する/" title="Slack の ボット で 定期的に降水予報を通知する" rel="bookmark">Slack の ボット で 定期的に降水予報を通知する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/13/Slackのボットでランダムなカスタム絵文字リアクションをする/" title="Slack の ボット で ランダムなカスタム絵文字リアクション を する" rel="bookmark">Slack の ボット で ランダムなカスタム絵文字リアクション を する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/15/SlackのボットでJRA競馬の開催日を通知する-JSON取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
    <article id="post-SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/" class="article-date">
  <time datetime="2017-01-20T15:00:00.000Z" itemprop="datePublished">2017-01-21</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/ボット/">ボット</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/">Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/slack/slack.png" alt title="Slack"></p>
<p>前回、<a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/">JRA の サイト から 開催日 iCalendar を 取得</a>し、ついに Slack の ボットへ組み込む準備ができました！ ボットへ組み込み、開催日を教えてもらいましょう.</p>
<p><strong>作業環境</strong></p>
<ul>
<li>Slack</li>
<li>Node.js 6.9.1 LTS</li>
<li>Botkit 0.4.9</li>
<li>unzip 0.1.11</li>
<li>ical2json 1.0.0</li>
<li>node-cron 1.2.1</li>
<li>moment-timezone 0.5.10</li>
</ul>
<h2 id="通知方法の検討"><a href="#通知方法の検討" class="headerlink" title="通知方法の検討"></a>通知方法の検討</h2><p>今回は GI レースに限定し、開催日 10日前 の 午前10時 に 通知するようにしたいと思います. Slack の チャンネルは、とりあえず実験用の #sandbox へ ポストするようにして様子見します.<br>土日などの連続開催がある場合、<em>開催日 10日前</em> だと連続して通知が来るようになってしまいますが、GI レースに限るとあまりないのでよしとします. GII や GIII が 入ってくると、土日連続がかなりあるようなので本格的に通知する場合は、同時通知できるようにした方がよさそうです.</p>
<h2 id="Slack-ボット-の-実装"><a href="#Slack-ボット-の-実装" class="headerlink" title="Slack ボット の 実装"></a>Slack ボット の 実装</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="keyword">const</span> Botkit = <span class="built_in">require</span>(<span class="string">'botkit'</span>);</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> cron = <span class="built_in">require</span>(<span class="string">'cron'</span>);</span><br><span class="line"><span class="keyword">const</span> unzip = <span class="built_in">require</span>(<span class="string">'unzip'</span>);</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">'moment-timezone'</span>);</span><br><span class="line"><span class="keyword">const</span> ical2json = <span class="built_in">require</span>(<span class="string">'ical2json'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> controller = Botkit.slackbot();</span><br><span class="line">controller.spawn(&#123;</span><br><span class="line">    token: process.env.bot_access_token</span><br><span class="line">&#125;).startRTM(<span class="function">(<span class="params">err, bot, payload</span>) =&gt;</span> &#123;</span><br><span class="line">    moment.locale(<span class="string">'ja'</span>);</span><br><span class="line">    moment.tz.setDefault(<span class="string">'Asia/Tokyo'</span>);</span><br><span class="line"></span><br><span class="line">    http.get(<span class="string">`http://www.jra.go.jp/keiba/common/calendar/jrarace2017.zip`</span>, (response) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> buffer = <span class="string">''</span>;</span><br><span class="line">        response.pipe(unzip.Parse()).on(<span class="string">'entry'</span>, (entry) =&gt; &#123;</span><br><span class="line">            entry.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;  buffer += chunk;  &#125;);</span><br><span class="line">            entry.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> ical = ical2json.convert(buffer)[<span class="string">'VEVENT'</span>];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> ical) &#123;</span><br><span class="line">                    <span class="keyword">let</span> data = ical[i];</span><br><span class="line">                    <span class="keyword">if</span> (data[<span class="string">'SUMMARY'</span>].includes(<span class="string">'GII'</span>)) &#123;  <span class="keyword">continue</span>;  &#125;</span><br><span class="line">                    <span class="keyword">new</span> cron.CronJob(&#123;</span><br><span class="line">                        cronTime: moment(<span class="string">`<span class="subst">$&#123;data[<span class="string">'DTSTART;VALUE=DATE'</span>]&#125;</span>T1000+0900`</span>).subtract(<span class="number">10</span>, <span class="string">'days'</span>).toDate(),</span><br><span class="line">                        onTick: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                            <span class="keyword">let</span> date = moment(<span class="keyword">this</span>.race[<span class="string">'DTSTART;VALUE=DATE'</span>]).format(<span class="string">'M/D(ddd)'</span>);</span><br><span class="line">                            <span class="keyword">let</span> race = <span class="keyword">this</span>.race[<span class="string">'SUMMARY'</span>].substring(<span class="number">0</span>, <span class="keyword">this</span>.race[<span class="string">'SUMMARY'</span>].indexOf(<span class="string">'('</span>))</span><br><span class="line">                            bot.say(&#123;</span><br><span class="line">                                text: <span class="string">`<span class="subst">$&#123;date&#125;</span> は <span class="subst">$&#123;race&#125;</span> ＠<span class="subst">$&#123;<span class="keyword">this</span>.race[<span class="string">'LOCATION'</span>]&#125;</span> だよ`</span>,</span><br><span class="line">                                channel: <span class="string">'sandbox'</span></span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;,</span><br><span class="line">                        start: <span class="literal">true</span>,</span><br><span class="line">                        timeZone: <span class="string">'Asia/Tokyo'</span>,</span><br><span class="line">                        context: &#123;  <span class="attr">race</span>: data  &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></table></figure>
<p>Slack ボット の 基本的な作りは <a href="/2017/01/12/Slackのボットで定時アクション/">Slack の ボット で 定時アクション</a> の 実装と変わりがありません. また、iCalendar の 取得部分も <a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/">Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編</a> と なります. これらの組み合わせでできています.</p>
<p><code>cron.CronJob</code> が HTTP GET の後に、繰り返しで作られているところがポイントになります.<br>開催日の情報を <code>moment-timezone</code> モジュールでパースし通知したい時刻とタイムゾーンを付けます. そして <code>subtract(10, &#39;days&#39;)</code> で 10日前の日付にし、<code>cronTime</code> へ <code>Date</code> オブジェクトとして渡します. <code>node-cron</code> は crontab の 文字列だけでなく <code>Date</code> オブジェクトも渡すことができるので、このように特定日の10日前といった指定ができます.</p>
<p>あとは <code>onTick</code> で ボットに話してもらうだけなのですが、ボットが話す際に開催情報が必要となります. これは <code>new cron.CronJob()</code> する際に、<code>context</code> で ジョブが起動した際に渡したいオブジェクトを指定することで可能となります. 今回は <code>context: { race: data }</code> とすることで iCalendar の データ <code>data</code> オブジェクト を <code>race</code> という名前でコンテキストに登録しておきました.<br><code>onTick</code> の 際には、<code>this.race</code> と コンテキストに渡した名前に <code>this</code> を つけてアクセスします.</p>
<p>※ 今回は <code>#sandbox</code> へ 発言するので <code>channel: &#39;sandbox&#39;</code> としていますが、ID で 指定したほうがよいので <code>https://slack.com/api/channels.list?token=[API_TOKEN]</code> へ アクセスして、ID を 調べます. また、発言先のチャンネルへボットが参加している必要があります.</p>
<h2 id="通知！"><a href="#通知！" class="headerlink" title="通知！"></a>通知！</h2><p><img src="/assets/slack/keiba/06.png" alt><br>今年最初の GI レースは 2月19日(日曜日) フェブラリーステークス ＠東京競馬場 が 通知されました！<br>ちょっと先なので、実験用に <code>cronTime</code> の 指定をいじりました. <code>T1000+0900</code> を <code>1000</code> でなく動作検証をする時間にし、<br><code>subtract(10, &#39;days&#39;)</code> を 2月19日 から 動作検証する日まで引いてあげます.<br>本投稿を書いているタイミング 1月21日 23時ごろで考えると <code>T2300+0900</code> で <code>subtract(29, &#39;days&#39;)</code> に なります.</p>
<hr>
<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51SYfM4adrL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">はじめてみようSlack 使いこなすための31のヒント</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">Slack研究会 パーソナルメディア 2016-08-03    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01L7HCBT2%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14364488%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>            <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-89-362326-3%2520%257C%25204-893-62326-3%2520%257C%25204-8936-2326-3%2520%257C%25204-89362-326-3%2520%257C%25204-893623-26-3%2520%257C%25204-8936232-6-3" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>

<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51g9K9r7quL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Slack入門 [ChatOpsによるチーム開発の効率化]</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">松下 雅和,小島 泰洋,長瀬 敦史,坂本 卓巳 技術評論社 2016-06-28    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01HI2TD28%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14263497%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>           <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-77-418238-4%2520%257C%25204-774-18238-4%2520%257C%25204-7741-8238-4%2520%257C%25204-77418-238-4%2520%257C%25204-774182-38-4%2520%257C%25204-7741823-8-4" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>



<hr>
<p>ボットで JRA の GI レース開催日 を Slack に 通知することができました. これで予め準備の上で観戦に臨めそうで楽しみです. (その前に基本的なことを勉強しておかないと…)</p>
<p><a href="/2017/01/12/Slackのボットで定時アクション/">定時アクションができるようになり</a> 定番の天気予報に着手しようと思っていましたが、思わぬ方向の機能を作ることになりましたが、おもしろい物ができたと思います. 思いついた時こそ勉強のチャンスですね.</p>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/" data-id="ckq2rxvb9003x44r2pi4yh4mn" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Botkit/">Botkit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Slack/">Slack</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/19/Slackのボットで2FA未設定ユーザを監視する-API確認編/" title="Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編" rel="bookmark">Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/13/Slackのボットでランダムなカスタム絵文字リアクションをする/" title="Slack の ボット で ランダムなカスタム絵文字リアクション を する" rel="bookmark">Slack の ボット で ランダムなカスタム絵文字リアクション を する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/15/SlackのボットでJRA競馬の開催日を通知する-JSON取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/12/Slackのボットで定時アクション/" title="Slack の ボット で 定時アクション" rel="bookmark">Slack の ボット で 定時アクション</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
    <article id="post-SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/" class="article-date">
  <time datetime="2017-01-17T15:00:00.000Z" itemprop="datePublished">2017-01-18</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/ボット/">ボット</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/">Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/slack/slack.png" alt title="Slack"></p>
<p>前回、<a href="/2017/01/15/SlackのボットでJRA競馬の開催日を通知する-JSON取得編/">JRA の サイト から 開催日 JSON を 取得</a>しました. ただ この方法については公開されているものを使っておらず、ウェブサイトのためのデータを勝手に使っているので お行儀が悪いです.<br>適切なデータを使って開催日の情報を扱えるようにしたいと思います.</p>
<p><strong>作業環境</strong></p>
<ul>
<li>Node.js 6.9.1 LTS</li>
<li>unzip 0.1.11</li>
<li>ical2json 1.0.0</li>
</ul>
<h2 id="開催日情報の取得方法について「再」検討"><a href="#開催日情報の取得方法について「再」検討" class="headerlink" title="開催日情報の取得方法について「再」検討"></a>開催日情報の取得方法について「再」検討</h2><p>データを取得する方法について、もう少し検討を進めたいと思います.<br><a href="http://www.jra.go.jp/datafile/seiseki/replay/2017/jyusyo.html" target="_blank" rel="noopener">重賞レース一覧</a> の ページがあり、こちらは HTML に 開催日情報 が 記述されています. スクレイピングすることでデータ化することができそうですが、HTML の 構造が変わるなどすると使えなくなってしまうので、最終手段にとっておきたいところです.</p>
<p>よくよくウェブサイトを見ていくと、レーシングカレンダー・ページ の 末尾 に <a href="http://www.jra.go.jp/keiba/calendar/index.html#ics_link" target="_blank" rel="noopener">他のカレンダー と 連携 の リンク</a> が ありました！<br><img src="/assets/slack/keiba/04.png" alt></p>
<p>この <a href="http://www.jra.go.jp/keiba/common/calendar/ics.html" target="_blank" rel="noopener">他のカレンダー と 連携</a> ページを確認すると、iCalendar 形式のファイルをダウンロードすることができるとのことです.<br><img src="/assets/slack/keiba/05.png" alt></p>
<p>これなら公開されているデータなので、安心して使うことができます. 年間開催のスケジュール と 年間の重賞スケジュール の 二つが用意されているようで、今回は重賞スケジュールのファイルを取得することにします.<br>また “開催中止等に伴うスケジュールの変更には対応しておりません。予めご了承ください。 – JRA” とのことですが、今回は開催日を通知することが目的で厳密なスケジュール運用は必要としないので、よしとします.</p>
<h2 id="iCalendar-の-取得方法"><a href="#iCalendar-の-取得方法" class="headerlink" title="iCalendar の 取得方法"></a>iCalendar の 取得方法</h2><p>前回と変わらず <code>http</code> モジュールで取得したいと思います.<br>今回は iCalendar ファイル が Zip で アーカイブされているので、その取扱いが必要となります.<br>Zip の 解凍は HTTP の レスポンスを Stream で 流し込めるので <a href="https://github.com/EvanOxfeld/node-unzip" target="_blank" rel="noopener">unzip</a> モジュールを使わせてもらいました. また iCalendar の 扱いは JSON に してほしかったので <a href="https://github.com/adrianlee44/ical2json" target="_blank" rel="noopener">ical2json</a> モジュールを使わせてもらいます. それぞれ標準では入っていないので <code>npm install [module name] --save</code> で インストールしておく必要があります.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> unzip = <span class="built_in">require</span>(<span class="string">'unzip'</span>);</span><br><span class="line"><span class="keyword">const</span> ical2json = <span class="built_in">require</span>(<span class="string">'ical2json'</span>);</span><br><span class="line"></span><br><span class="line">http.get(<span class="string">`http://www.jra.go.jp/keiba/common/calendar/jrarace2017.zip`</span>, (response) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> buffer = <span class="string">''</span>;</span><br><span class="line">    response.pipe(unzip.Parse()).on(<span class="string">'entry'</span>, (entry) =&gt; &#123;</span><br><span class="line">        entry.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;  buffer += chunk;  &#125;);</span><br><span class="line">        entry.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> ical = ical2json.convert(buffer)[<span class="string">'VEVENT'</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> ical) &#123;</span><br><span class="line">                <span class="keyword">let</span> data = ical[i];</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;data[<span class="string">'DTSTART;VALUE=DATE'</span>]&#125;</span> <span class="subst">$&#123;data[<span class="string">'SUMMARY'</span>]&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></table></figure></p>
<p>構造としては、前回 の JSON 取得と変わりありません.<br><code>response</code> を 直接扱うのではなく <code>unzip</code> の <code>Parse()</code> に パイプして、HTTP GET で 取得するデータを直接 <code>unzip</code> に 流すところがポイントになります.<br>これにより 一時ファイルに落とさず直接解凍して処理を行うことができます. 今回も解凍して 45 KB ちょっとなので、変数に入れてメモリ上で処理してしまいます.<br>あとは <code>ical2json</code> モジュールが iCalendar の フィールド名 を キーとして JSON に してくれるので、プログラムで簡単に扱うことができます.</p>
<hr>
<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51SYfM4adrL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">はじめてみようSlack 使いこなすための31のヒント</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">Slack研究会 パーソナルメディア 2016-08-03    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01L7HCBT2%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14364488%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>            <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-89-362326-3%2520%257C%25204-893-62326-3%2520%257C%25204-8936-2326-3%2520%257C%25204-89362-326-3%2520%257C%25204-893623-26-3%2520%257C%25204-8936232-6-3" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>

<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51g9K9r7quL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Slack入門 [ChatOpsによるチーム開発の効率化]</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">松下 雅和,小島 泰洋,長瀬 敦史,坂本 卓巳 技術評論社 2016-06-28    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01HI2TD28%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14263497%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>           <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-77-418238-4%2520%257C%25204-774-18238-4%2520%257C%25204-7741-8238-4%2520%257C%25204-77418-238-4%2520%257C%25204-774182-38-4%2520%257C%25204-7741823-8-4" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>



<hr>
<p>無事に公開されているデータで開催日を取得することができました. JSON のように データが構造化しきれないので、グレード は 自前で文字列処理が必要となりますが、十分利用できそうです. なにより 1年分が 1回で取れるのがよいですね.<br>ファイル置き場の URL が 変わらなければ、年数の部分だけ自動処理すれば使いづづけられそうです. 年単位なので いきなり変わることもありそうだけど…</p>
<p>Node.js には いろいろなモジュールがあるので選択に迷いますが、素晴らしいモジュールを提供してくださっている方々のおかげで簡単に実装できるので助かります. ありがとうございます！</p>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/" data-id="ckq2rxvb8003v44r2vqrmx1pm" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Botkit/">Botkit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Slack/">Slack</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/19/Slackのボットで2FA未設定ユーザを監視する-API確認編/" title="Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編" rel="bookmark">Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/13/Slackのボットでランダムなカスタム絵文字リアクションをする/" title="Slack の ボット で ランダムなカスタム絵文字リアクション を する" rel="bookmark">Slack の ボット で ランダムなカスタム絵文字リアクション を する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/15/SlackのボットでJRA競馬の開催日を通知する-JSON取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/12/Slackのボットで定時アクション/" title="Slack の ボット で 定時アクション" rel="bookmark">Slack の ボット で 定時アクション</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
    <article id="post-SlackのボットでJRA競馬の開催日を通知する-JSON取得編" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/15/SlackのボットでJRA競馬の開催日を通知する-JSON取得編/" class="article-date">
  <time datetime="2017-01-14T15:00:00.000Z" itemprop="datePublished">2017-01-15</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/ボット/">ボット</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2017/01/15/SlackのボットでJRA競馬の開催日を通知する-JSON取得編/">Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/slack/slack.png" alt title="Slack"></p>
<p>2016年 の 有馬記念 を 見て、急に競馬が気になりだしました. とはいえ、ちゃんとやったこともないし、いつやっているのかも知らない、といったレベルなので、次週の開催予定をボットに通知してもらうようにして、下調べぐらいはしてから見れるようにしたいと思います.<br>ボットにしゃべってもらうにはデータが必要なので、まずは開催日のデータ探しと取得方法について考えます.<br>→ 公開されているデータを取得するよう <a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/">Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編</a> の 記事を追加しました. (2017年1月18日追記）</p>
<p><strong>作業環境</strong></p>
<ul>
<li>Node.js 6.9.1 LTS</li>
</ul>
<h2 id="開催日情報の取得方法について検討"><a href="#開催日情報の取得方法について検討" class="headerlink" title="開催日情報の取得方法について検討"></a>開催日情報の取得方法について検討</h2><p>JRA の サイトに <a href="http://www.jra.go.jp/keiba/calendar/" target="_blank" rel="noopener">レーシングカレンダー</a> があり、さまざまな情報が載っています. しかし開催情報を取得できるような Web API は なさそうです. また、そのような情報を提供しているサイトも見当たりませんでした. (なんか、ありそうな気もするんですが…)</p>
<p>レーシングカレンダー の ソースを見ると、<a href="http://www.jra.go.jp/keiba/common/calendar/cal.js" target="_blank" rel="noopener">JavaScript で カレンダー生成</a>を行っていることが分かります. ソースには 2015 と ありますが、2017年も順調に機能しているようです.<br><img src="/assets/slack/keiba/01.png" alt></p>
<p>その中に JSON ファイルを取得している部分があります！ この <a href="http://www.jra.go.jp/keiba/common/calendar/json/201701.json" target="_blank" rel="noopener">JSON ファイル</a> を 使う手もありそうです.<br><img src="/assets/slack/keiba/02.png" alt></p>
<p>過去の JSON ファイルを探っていくと、<a href="http://www.jra.go.jp/keiba/common/calendar/json/201201.json" target="_blank" rel="noopener">2012年1月</a> が 一番古いようです. カレンダーの描画部分は 2015年にリニューアルしたとして、システム自体は 2012年には稼働していたのでしょうか.<br><img src="/assets/slack/keiba/03.png" alt></p>
<h2 id="JSON-の-取得方法"><a href="#JSON-の-取得方法" class="headerlink" title="JSON の 取得方法"></a>JSON の 取得方法</h2><p>とりあえず、この JSON を 取得してみたいと思います.<br>Node.js で HTTP リクエストするには、<code>http</code> モジュールを使います. 標準で組み込まれているので簡単に使い始められます. もう少し手軽に扱ったり、複雑なことをするには <code>request</code> が よいようですが、今回は簡単な HTTP GET なので <code>http</code> で いきたいとおもいます.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre><td class="code"><pre><span class="line"><span class="keyword">let</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line">http.get(<span class="string">`http://www.jra.go.jp/keiba/common/calendar/json/201701.json`</span>, (response) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> buffer = <span class="string">''</span>;</span><br><span class="line">    response.setEncoding(<span class="string">'utf8'</span>).on(<span class="string">'data'</span>, (chunk) =&gt; &#123;  buffer += chunk;  &#125;);</span><br><span class="line">    response.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> json = <span class="built_in">JSON</span>.parse(buffer)[<span class="number">0</span>].data;</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> json) &#123;</span><br><span class="line">            <span class="keyword">for</span> (j <span class="keyword">in</span> json[i].info[<span class="number">0</span>].gradeRace) &#123;</span><br><span class="line">                <span class="keyword">let</span> data = json[i];</span><br><span class="line">                <span class="keyword">let</span> race = data.info[<span class="number">0</span>].gradeRace[j];</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;data.date&#125;</span>(<span class="subst">$&#123;data.day&#125;</span>) <span class="subst">$&#123;race.grade&#125;</span> <span class="subst">$&#123;race.name&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></table></figure></p>
<p>一時ファイルに落としても良かったのですが、ファイルとして取っておく必要もなく 1 JSON ファイルあたり 7 KB ちょっとなので変数で直接持ってしまいます.<br><code>http</code> は <code>data</code> イベントで読み込んだ分の情報を返します. 全てを読み込んだ結果ではないことに注意です. 読み込みが終わるまで変数に追加し保持しておきます.<br>全てが読み込み終わると <code>end</code> イベントが発生するので、このタイミングで保持しておいたデータを処理します. 今回は読み込んだ情報を JSON オブジェクトにし、1行ごとに開催日とグレード、レース名をコンソールに出すようにしました.</p>
<p>これを 月ごとの JSON ファイルを取得するようにすれば、開催日の情報をボットに通知してもらうことができそうです.</p>
<hr>
<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51SYfM4adrL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">はじめてみようSlack 使いこなすための31のヒント</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">Slack研究会 パーソナルメディア 2016-08-03    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01L7HCBT2%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14364488%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>            <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-89-362326-3%2520%257C%25204-893-62326-3%2520%257C%25204-8936-2326-3%2520%257C%25204-89362-326-3%2520%257C%25204-893623-26-3%2520%257C%25204-8936232-6-3" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>

<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51g9K9r7quL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Slack入門 [ChatOpsによるチーム開発の効率化]</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">松下 雅和,小島 泰洋,長瀬 敦史,坂本 卓巳 技術評論社 2016-06-28    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01HI2TD28%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14263497%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>           <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-77-418238-4%2520%257C%25204-774-18238-4%2520%257C%25204-7741-8238-4%2520%257C%25204-77418-238-4%2520%257C%25204-774182-38-4%2520%257C%25204-7741823-8-4" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>



<hr>
<p>JRA の 開催日情報を取得できました. これを活用することで事前にレース開催日を知ることができるので、心して観戦に望めそう<br>ところで この JSON、JRA の ウェブサイトのカレンダーを描画するためのデータをもらっているわけですが、公式に公開されているものではないので勝手に使うのは お行儀がよくないです. やはりちゃんと公開されているデータを使いたいところです.</p>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2017/01/15/SlackのボットでJRA競馬の開催日を通知する-JSON取得編/" data-id="ckq2rxvb7003s44r2urbzo5q0" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Botkit/">Botkit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Slack/">Slack</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/19/Slackのボットで2FA未設定ユーザを監視する-API確認編/" title="Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編" rel="bookmark">Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/13/Slackのボットでランダムなカスタム絵文字リアクションをする/" title="Slack の ボット で ランダムなカスタム絵文字リアクション を する" rel="bookmark">Slack の ボット で ランダムなカスタム絵文字リアクション を する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/12/Slackのボットで定時アクション/" title="Slack の ボット で 定時アクション" rel="bookmark">Slack の ボット で 定時アクション</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
    <article id="post-Slackのボットで定時アクション" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/12/Slackのボットで定時アクション/" class="article-date">
  <time datetime="2017-01-11T15:00:00.000Z" itemprop="datePublished">2017-01-12</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/ボット/">ボット</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2017/01/12/Slackのボットで定時アクション/">Slack の ボット で 定時アクション</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/slack/slack.png" alt title="Slack"></p>
<p>Slack に 設置したボットを一定時間ごとに発言するようにしたいと思います.<br>定時アクションができるようになると、天気の情報を毎朝ポストしてもらうなど活用の幅が広がります.</p>
<p><strong>作業環境</strong></p>
<ul>
<li>Slack</li>
<li>Node.js 6.9.1 LTS</li>
<li>Botkit 0.4.9</li>
<li>node-cron 1.2.1</li>
</ul>
<h2 id="Node-js-に-cron-を-追加"><a href="#Node-js-に-cron-を-追加" class="headerlink" title="Node.js に cron を 追加"></a>Node.js に cron を 追加</h2><p>Linux などの OS で 定期的な処理を行うには <a href="https://ja.wikipedia.org/wiki/Crontab" target="_blank" rel="noopener">cron → crontab - Wikipedia</a> が 使われます. Node.js でも同様に <code>cron</code> と呼ばれるモジュールが<a href="https://www.npmjs.com/search?q=cron" target="_blank" rel="noopener">いくつか</a>あります.<br>今回は <a href="https://github.com/kelektiv" target="_blank" rel="noopener">Kelektiv</a>さん の <a href="https://github.com/kelektiv/node-cron" target="_blank" rel="noopener">node-cron</a> を 使いたいと思います.</p>
<p>ボットのプロジェクト・ディレクトリで以下のコマンドを実行し <code>node-cron</code> モジュールをインストールします.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre><td class="code"><pre><span class="line">c:\Develop\repos\slack-bot&gt; npm install cron --save</span><br><span class="line">`-- cron@1.2.1</span><br></pre></table></figure></p>
<p><em>メモ</em><br><code>node-cron</code> という名前のモジュールは <a href="https://github.com/kelektiv" target="_blank" rel="noopener">Kelektiv</a>さん と <a href="https://github.com/merencia" target="_blank" rel="noopener">Merencia</a>さん の 2つがあるので注意が必要です.<br>今回は タイムゾーンが指定できることと 、日付指定の実行ができることなどから <a href="https://github.com/kelektiv" target="_blank" rel="noopener">Kelektiv</a>さん のを使わせていただきました.<br>特にタイムゾーンを意識する必要がない場合は、<a href="https://github.com/merencia" target="_blank" rel="noopener">Merencia</a>さん のも シンプルな実装でよいかもしれません.</p>
<h2 id="Botkit-での-定時処理"><a href="#Botkit-での-定時処理" class="headerlink" title="Botkit での 定時処理"></a>Botkit での 定時処理</h2><p>とりあえず、月曜日～金曜日 の 毎朝 9:00 に 挨拶をするようにしたいと思います.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre><td class="code"><pre><span class="line"><span class="keyword">const</span> Botkit = <span class="built_in">require</span>(<span class="string">'botkit'</span>);</span><br><span class="line"><span class="keyword">const</span> cron = <span class="built_in">require</span>(<span class="string">'cron'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> controller = Botkit.slackbot();</span><br><span class="line"></span><br><span class="line">controller.spawn(&#123;</span><br><span class="line">    token : process.env.token</span><br><span class="line">&#125;).startRTM(<span class="function">(<span class="params">err, bot, payload</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> cron.CronJob(&#123;</span><br><span class="line">        cronTime: <span class="string">'00 00 09 * * 1-5'</span>,</span><br><span class="line">        onTick: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            bot.say(&#123;</span><br><span class="line">                channel: <span class="string">'random'</span>,</span><br><span class="line">                text: <span class="string">':smiley: おはようございます！'</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        start: <span class="literal">true</span>,</span><br><span class="line">        timeZone: <span class="string">'Asia/Tokyo'</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></table></figure></p>
<ul>
<li>ボット起動時に cron の 処理を登録したいので、<code>startRTM()</code> の 中で <code>new cron.CronJob()</code> します.</li>
<li><code>cronTime</code> は <a href="https://github.com/kelektiv/node-cron#cron-ranges" target="_blank" rel="noopener">Cron Ranges</a> に従い、起動したい時間を指定します. 今回は「月曜日～金曜日 の 毎朝 9:00」なので、前半 の <code>00 00 09 ~~~</code> で 9:00 を 指定し、後半 の <code>~~~ * * 1-5</code> で 毎月毎日(<code>* * ~~~</code>) に 加えて 最後の <code>1-5</code> で 月曜日～金曜日(0 は 日曜日) を 指定します.</li>
<li><code>onTick</code> に <code>cronTime</code> で 指定したタイミングで行う処理を記述します. 今回は Botkit に <code>#random</code> チャンネル へ 挨拶を発言しさせます.</li>
<li><code>start</code> は <code>true</code> にすることで、そのまま cron の 処理を開始させます. 処理開始を明示的に行いたい場合は <code>false</code> にし、開始したい場所で <code>start()</code> を 呼び出しますが、今回は即時に処理を開始してよいので <code>true</code> にしました.</li>
<li><code>timeZone</code> で <code>cronTime</code> に 指定するタイムゾーンを明示します. 最近はクラウド環境を使ったりするのでタイムゾーンは意識的に書いておいた方がトラブルに合いにくい気がします.</li>
</ul>
<p>※ 今回は <code>#random</code> へ 発言するので <code>channel: &#39;random&#39;</code> としていますが、ID で 指定したほうがよいので <code>https://slack.com/api/channels.list?token=[API_TOKEN]</code> へ アクセスして、ID を 調べます. また、発言先のチャンネルへボットが参加している必要があります.</p>
<h2 id="実行！"><a href="#実行！" class="headerlink" title="実行！"></a>実行！</h2><p>通常通り起動し、<code>cronTime</code> で 指定した時間を待ちます. 無事、ボットが挨拶をしてくれたでしょうか！？<br><img src="/assets/slack/bot/cron.png" alt></p>
<hr>
<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51SYfM4adrL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">はじめてみようSlack 使いこなすための31のヒント</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">Slack研究会 パーソナルメディア 2016-08-03    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01L7HCBT2%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14364488%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>            <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-89-362326-3%2520%257C%25204-893-62326-3%2520%257C%25204-8936-2326-3%2520%257C%25204-89362-326-3%2520%257C%25204-893623-26-3%2520%257C%25204-8936232-6-3" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>

<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51g9K9r7quL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Slack入門 [ChatOpsによるチーム開発の効率化]</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">松下 雅和,小島 泰洋,長瀬 敦史,坂本 卓巳 技術評論社 2016-06-28    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01HI2TD28%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14263497%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>           <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-77-418238-4%2520%257C%25204-774-18238-4%2520%257C%25204-7741-8238-4%2520%257C%25204-77418-238-4%2520%257C%25204-774182-38-4%2520%257C%25204-7741823-8-4" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>



<hr>
<p>Node.js の モジュールを使うことで簡単に、ボットの定時アクションを実装することができました！ モジュールを作ってくださる方々のおかげで、やりたいことがすぐにできるので助かります. 感謝感謝です.<br>次回はオーソドックスに天気を知らせてくれる機能を追加しようかな～</p>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2017/01/12/Slackのボットで定時アクション/" data-id="ckq2rxvbb004144r2uph95xni" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Botkit/">Botkit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Slack/">Slack</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/19/Slackのボットで2FA未設定ユーザを監視する-API確認編/" title="Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編" rel="bookmark">Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/13/Slackのボットでランダムなカスタム絵文字リアクションをする/" title="Slack の ボット で ランダムなカスタム絵文字リアクション を する" rel="bookmark">Slack の ボット で ランダムなカスタム絵文字リアクション を する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/15/SlackのボットでJRA競馬の開催日を通知する-JSON取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
    <article id="post-Hexoの投稿記事URLを変更する" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/09/Hexoの投稿記事URLを変更する/" class="article-date">
  <time datetime="2017-01-08T15:00:00.000Z" itemprop="datePublished">2017-01-09</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/ブログ/">ブログ</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2017/01/09/Hexoの投稿記事URLを変更する/">Hexo の 投稿記事 URL を 変更する</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/hexo/hexo-3.2.png" alt title="Hexo"></p>
<p>Hexo の 投稿記事 の URL は、タイトルが使われます. その際に半角スペースをハイフン(-) に 置き換えてくれるのですが、私は日本語とアルファベットが混ざる際に半角スペースを入れてレイアウトを調整します. そうなると URL 日本語なのにハイフンだらけとなってしまいます. 昔のブラウザは URL エンコードされた文字列だったので気にもならなかったのですが、最近のブラウザはでコードして日本語で表示してくれるので気になってしまうので、極力 ハイフンなし の URL に 戻したいと思います.</p>
<p><strong>作業環境</strong></p>
<ul>
<li>Windows 7</li>
<li>Hexo 3.2</li>
<li>hexo-generator-alias 0.1.3</li>
</ul>
<h2 id="記事のファイル名を変更する"><a href="#記事のファイル名を変更する" class="headerlink" title="記事のファイル名を変更する"></a>記事のファイル名を変更する</h2><p>URL を 変更するには、各投稿記事のファイル名を変更し再生成するだけです. 簡単！<br>アルファベットの区切りとしての半角スペース(＝ハイフン) は よいので、日本語とアルファベットの間でレイアウト調整した分だけ、ハイフンを消してファイル名変更します.</p>
<p><em>メモ</em><br>ファイル名を変更するということは、古いファイルを消して、新しいファイルを作ることなのですが、<code>hexo generate</code> は 生成済みのファイルの削除は行ってくれないようです. 基本的に投稿を削除するということはないので通常はそれでよいのですが、今回のようにファイル名変更した場合は <code>hexo clean</code> して生成済みのファイルを削除してから <code>hexo generate</code> する必要があります.</p>
<h2 id="古い-URL-からのリダイレクトを設定"><a href="#古い-URL-からのリダイレクトを設定" class="headerlink" title="古い URL からのリダイレクトを設定"></a>古い URL からのリダイレクトを設定</h2><p>ファイル名を変更することで URL を 変更できましたが、古い URL へのケアが必要です. リンクしてくださっている サイト や SNS の 投稿などがありましたら <code>404 Not Found</code> に なってしまいますし、Google などの 検索エンジンからは重複記事と見えてしまいます. そのようなことにならないよう、古い URL に リダイレクトの設定をしておきます.</p>
<p>Hexo で リダイレクト設定するには、<a href="https://github.com/hexojs/hexo-generator-alias" target="_blank" rel="noopener">hexo-generator-alias</a> を 使います.<br>Hexo の ソースがあるフォルダで <code>npm install hexo-generator-alias --save</code> を実行します. ついでに各 Plugin の アップデートもしておきます. (下記例の [username] は 自分の GitHub ユーザ名)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre><td class="code"><pre><span class="line">C:\Develop\repos\[username].github.io&gt; npm update</span><br><span class="line">C:\Develop\repos\[username].github.io&gt; npm install hexo-generator-alias --save</span><br><span class="line">`-- hexo-generator-alias@0.1.3</span><br><span class="line">npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@^1.0.0 (node_modules\chokidar\node_modules\fsevents):</span><br><span class="line">npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@1.0.17: wanted &#123;&quot;os&quot;:&quot;darwin&quot;,&quot;arch&quot;:&quot;any&quot;&#125; (current: &#123;&quot;os&quot;:&quot;win32&quot;,&quot;arch&quot;:&quot;x64&quot;&#125;)</span><br></pre></table></figure></p>
<p>リダイレクトの設定 は 各投稿のファイル もしくは、<code>_config.yml</code> で 行います.<br><code>_config.yml</code> は 全体設定を置いておきたいので、今回は各投稿のファイルに書きます. たとえば本ブログの最初の記事の例で、以下のように Front-matter へ <code>alias: [古い URL]</code> を 追加します.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">Hexo</span> <span class="string">と</span> <span class="string">GitHub</span> <span class="string">Pages</span> <span class="string">で</span> <span class="string">ブログ環境の構築</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2016</span><span class="bullet">-11</span><span class="bullet">-01</span></span><br><span class="line"><span class="attr">categories:</span> <span class="string">ブログ</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Hexo</span></span><br><span class="line"><span class="attr">alias:</span> <span class="string">/2016/11/01/Hexo-と-GitHub-Pages-で-ブログ環境の構築/</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></table></figure></p>
<p>対象となる投稿記事の設定が終わったら、<code>hexo clean</code>, <code>hexo generate</code> で 再生成します.<br>これにより公開フォルダが以下のように生成され、古い URL にも <code>index.html</code> が 生成されています.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre><td class="code"><pre><span class="line">c:\Develop\repos\personal\[username].github.io&gt;tree /F</span><br><span class="line">C:.</span><br><span class="line">├─.deploy_git</span><br><span class="line">├─.settings</span><br><span class="line">├─node_modules</span><br><span class="line">├─public</span><br><span class="line">│  ├─2016</span><br><span class="line">│  │  ├─11</span><br><span class="line">│  │  │  ├─01</span><br><span class="line">│  │  │  │  ├─Hexo-と-GitHub-Pages-で-ブログ環境の構築</span><br><span class="line">│  │  │  │  │      index.html</span><br><span class="line">│  │  │  │  └─HexoとGitHub-Pagesでブログ環境の構築</span><br><span class="line">│  │  │  │          index.html</span><br><span class="line">│</span><br><span class="line">├─scaffolds</span><br><span class="line">├─source</span><br><span class="line">└─themes</span><br></pre></table></figure></p>
<p>古い URL の <code>index.html</code> は、以下のようにリダイレクトのソースが生成されています. (実際は 1行、投稿用に整形済み)<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Redirecting...<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"canonical"</span> <span class="attr">href</span>=<span class="string">"/2016/11/01/HexoとGitHub-Pagesでブログ環境の構築/"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"0; url=/2016/11/01/HexoとGitHub-Pagesでブログ環境の構築/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></table></figure></p>
<hr>
<p>URL の 変更を無事に行うことができました. 最初からちゃんと URL 構成を考えておけば、こんなことにならなかったわけですが、まぁ仕方ない. エイリアス設定の勉強ができたのでよしとしましょう.</p>
<p>ところで本件の原因となった、全角と半角が混ざる際に半角スペースを入れたくなる問題、本当は CSS なりのスタイル側で処理してくれるとよいもので、文章上の意味を持たないのにレイアウトとして半角スペースを入れるのはよくないのかなぁとは考えています…<br>とはいえ現状はスタイル側で対応できないので致し方なし、といういうのと対比となる文の場合で強調するほどでもないときに半角スペースを入れることで、自然な強調にできるのでよく使っていたりもします.</p>
<p>このあたり、みなさん いろいろと苦労されていらっしゃるようで、私もよい解があったら ぜひ乗りたいなぁ.</p>
<ul>
<li><a href="http://d.hatena.ne.jp/jacquelinet/20090422/p1" target="_blank" rel="noopener">「全角文字と半角英字の間にはスペースを入れるが全角文字と半角数字の間には入れない」というルール - IT翻訳者の疑問</a></li>
<li><a href="https://portalshit.net/2007/01/13/732" target="_blank" rel="noopener">半角スペース入れてますか？ - portal shit!</a></li>
<li><a href="http://blog.livedoor.jp/tanahata/archives/50970576.html" target="_blank" rel="noopener">日本語とアルファベットとの間に半角スペースを入れるか否か。 :: キミガタメ「ハ」</a></li>
<li><a href="http://a-clinical-psychologist.blogspot.jp/2014/10/blog-post.html" target="_blank" rel="noopener">論文における日本語と英語の混在ルール - 臨床心理士的Blogger</a></li>
</ul>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2017/01/09/Hexoの投稿記事URLを変更する/" data-id="ckq2rxv9p000r44r22y4a9dgw" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/">Hexo</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/02/13/Hexoの新規投稿パスをカスタマイズ/" title="Hexo の 新規投稿パス を カスタマイズ" rel="bookmark">Hexo の 新規投稿パス を カスタマイズ</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2016/11/07/Hexoのフィードとサイトマップを設定/" title="Hexo の フィード と サイトマップ を 設定" rel="bookmark">Hexo の フィード と サイトマップ を 設定</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2016/11/10/ところで、Hexoって何て読むんだろ？/" title="ところで、Hexo って 何て読むんだろ？" rel="bookmark">ところで、Hexo って 何て読むんだろ？</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2016/12/08/CircleCIでHexoの自動ビルドとデプロイ設定/" title="CircleCI で Hexo の 自動ビルド と デプロイ設定" rel="bookmark">CircleCI で Hexo の 自動ビルド と デプロイ設定</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2016/12/20/HexoにGoogle-Analyticsを設置する/" title="Hexo に Google Analytics を 設置する" rel="bookmark">Hexo に Google Analytics を 設置する</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
    <article id="post-HexoでPubSubHubbub通知をする" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/06/HexoでPubSubHubbub通知をする/" class="article-date">
  <time datetime="2017-01-05T15:00:00.000Z" itemprop="datePublished">2017-01-06</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/ブログ/">ブログ</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2017/01/06/HexoでPubSubHubbub通知をする/">Hexo で PubSubHubbub 通知をする</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/hexo/hexo-3.2.png" alt title="Hexo"></p>
<p><a href="/2016/11/07/Hexoのフィードとサイトマップを設定/">Hexo の フィード出力を設定</a>した際に、設定項目で気になったものがありました. “hub - URL of the PubSubHubbub hubs (Leave it empty if you don’t use it) – <a href="https://github.com/hexojs/hexo-generator-feed" target="_blank" rel="noopener">hexo-generator-feed</a>“ です.</p>
<p>そもそも PubSubHubbub 自体を知らなかったのですが、”パブサブハバブ – <a href="https://ja.wikipedia.org/wiki/PubSubHubbub" target="_blank" rel="noopener">Wikipedia</a>“ と 読むそうで、データの変更(ここでは、ブログの更新情報) を リアルタイムに通知するためのプロトコルなのだそうです.</p>
<p>この仕組みを使うことで、Google などの検索エンジンにブログの更新を効率よく通知することができ、インデックス化を早めることができるとのことで、早速導入したいと思います.</p>
<p><strong>作業環境</strong></p>
<ul>
<li>Windows 7</li>
<li>Hexo 3.2</li>
<li>hexo-generator-feed 1.2.0</li>
<li>GitHub (GitHub Pages / Webhook)</li>
</ul>
<h2 id="PubSubHubbub-とは？"><a href="#PubSubHubbub-とは？" class="headerlink" title="PubSubHubbub とは？"></a>PubSubHubbub とは？</h2><p>PubSubHubbub は、分散型 の パブリッシュ(発行)/サブスクライブ(購読) コミュニケーション を 行うためのオープンなプロトコルで、仕様は <a href="https://github.com/pubsubhubbub/PubSubHubbub" target="_blank" rel="noopener">https://github.com/pubsubhubbub/PubSubHubbub</a> で 公開されています. 2017年1月現在のバージョン は <a href="http://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html" target="_blank" rel="noopener">0.4</a> です.</p>
<p>ざっくり言うと、情報の提供者と利用者の間にハブを置くことで、それぞれが分離した作業ができるようにし、またプッシュ型にすることで情報の利用者が提供者のサーバへ定期的なポーリングせず不要な負荷を下げることができるようになります.<br>利用例として<a href="http://xml.kishou.go.jp/open_trial/guidance.html" target="_blank" rel="noopener">気象庁の電文公開</a>があります.<br><img src="/assets/hexo/pubsubhubbub/01.png" alt></p>
<p>今回は、この仕組みを使い <a href="http://pubsubhubbub.appspot.com/" target="_blank" rel="noopener">Google PubSubHubbub Hub</a> へ ブログの更新情報をプッシュし、Google の クローラー へ ブログの更新に関する情報を購読してもらいます. これによって Google の クローラー が 定期的にブログの更新を確認しに来てくれていたのを、こちらからクローラーへ来てもらうことができるようになります.</p>
<p>これまでは Google の クローラーが来てくれるのを ただ待っていただけですが、PubSubHubbub を 使うことでクローラーを呼び込むことができ、検索エンジンのインデックス化を格段に早めることができるようになります.</p>
<h2 id="Hexo-に-PubSubHubbub-を-設定"><a href="#Hexo-に-PubSubHubbub-を-設定" class="headerlink" title="Hexo に PubSubHubbub を 設定"></a>Hexo に PubSubHubbub を 設定</h2><p>PubSubHubbub は RSS や Atom フィード で 情報を提供します. hexo-generator-feed が  PubSubHubbub の 情報生成に対応しているので、まずは hexo-generator-feed の 設定を行います.</p>
<p><code>config.yml</code> の hexo-generator-feed に 関する設定に <code>hub: http://pubsubhubbub.appspot.com</code> を 追加します.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre><td class="code"><pre><span class="line">feed:</span><br><span class="line">  type: atom</span><br><span class="line">  path: atom.xml</span><br><span class="line">  limit: 20</span><br><span class="line">  hub: http://pubsubhubbub.appspot.com</span><br></pre></table></figure></p>
<p><code>hexo generate</code> で サイトを再生成してローカルサーバ <a href="http://localhost:4000/atom.xml" target="_blank" rel="noopener">http://localhost:4000/atom.xml</a> でフィードを確認してみると、<code>&lt;link href=&quot;http://pubsubhubbub.appspot.com&quot; rel=&quot;hub&quot;/&gt;</code> が 増えているのが分かります.<br><img src="/assets/hexo/pubsubhubbub/02.png" alt></p>
<h2 id="GitHub-の-Webhook-で-PubSubHubbub-通知設定"><a href="#GitHub-の-Webhook-で-PubSubHubbub-通知設定" class="headerlink" title="GitHub の Webhook で PubSubHubbub 通知設定"></a>GitHub の Webhook で PubSubHubbub 通知設定</h2><p>hexo-generator-feed の 設定はフィードの出力設定で、PubSubHubbub の ハブ (Google PubSubHubbub Hub) への通知は別途行う必要があります.<br>GitHub Pages で ウェブサイトを公開しているので、今回は GitHub の Webhook を 使って更新時にハブへ通知するようにしたいと思います.</p>
<p>GitHub リポジトリ の Setting ページ から、Webhooks を 表示し、右側の [Add webhook] ボタンをクリックします.<br><img src="/assets/hexo/pubsubhubbub/03.png" alt></p>
<p>以下の情報を入力し、[Add webhook] ボタンをクリックします.</p>
<table>
<thead>
<tr>
<th style="text-align:left">設定項目
<th style="text-align:left">設定内容


<tbody>
<tr>
<td style="text-align:left">Payload URL
<td style="text-align:left">[PubSubHubbub 通知 URL(※)]

<tr>
<td style="text-align:left">Content type
<td style="text-align:left"><code>application/x-www-form-urlencoded</code> を 選択

<tr>
<td style="text-align:left">Secret
<td style="text-align:left">[空欄]

<tr>
<td style="text-align:left">Which events…
<td style="text-align:left"><code>Let me select individual events.</code> → <code>Page build</code>  に チェック


</table>
<p>[PubSubHubbub 通知 URL] は <code>https://pubsubhubbub.appspot.com/publish?hub.mode=publish&amp;hub.url=https://[username].github.io/atom.xml</code> で、[username] を 自分のユーザ名に置き換える、もしくは <code>hub.url=</code> 以降に自分のサイトのフィード の URL にします.<br>心配な場合は <a href="https://pubsubhubbub.appspot.com/publish" target="_blank" rel="noopener">https://pubsubhubbub.appspot.com/publish</a> で 正しいか検証することができます.</p>
<p>また [Which events…] は <code>Page build</code> だけにし、GitHub Pages の ページがビルドされた時だけ通知するようにします. Push だと、ドラフトの記事を GitHub に 上げた際にも通知されてしまい、不要な通知がハブへ行ってしまいます.<br><img src="/assets/hexo/pubsubhubbub/04.png" alt></p>
<p>Webhook が 追加されました. タイミングによっては通知のテストが行われておらずチェックがついてません. URL 部分をクリックし設定から通知テストを確認するかリロードして確認します.<br><img src="/assets/hexo/pubsubhubbub/05.png" alt></p>
<p>通知テストの結果は Wehbook の 設定画面の一番下にあり、Response が <code>204</code> に なっていれば成功です.<br>実動作の確認としては CircleCI から再ビルドするか、<code>hexo deploy</code> で サイトを更新します. 正しくデプロイできると、この画面 の Recent Deliveries が増えます.<br><img src="/assets/hexo/pubsubhubbub/06.png" alt></p>
<hr>
<p>ブログ に PubSubHubbub の 通知を追加できました. これにより、より早く記事が検索できるようになるといいですね. また読んでいただけるような、しっかりした記事をかけるようにしていきたいと思います. どうぞ 今後ともよろしくお願いいたします.</p>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2017/01/06/HexoでPubSubHubbub通知をする/" data-id="ckq2rxv9o000m44r2znn0w312" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GitHub/">GitHub</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/">Hexo</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2016/12/08/CircleCIでHexoの自動ビルドとデプロイ設定/" title="CircleCI で Hexo の 自動ビルド と デプロイ設定" rel="bookmark">CircleCI で Hexo の 自動ビルド と デプロイ設定</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/03/01/Hexoのフッターにソーシャル・アイコンを設置/" title="Hexo の フッター に ソーシャル・アイコン を 設置" rel="bookmark">Hexo の フッター に ソーシャル・アイコン を 設置</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/10/11/Hexoに404-Not-Foundページを追加する/" title="Hexo に 404 Not Found ページ を 追加する" rel="bookmark">Hexo に 404 Not Found ページ を 追加する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2016/11/01/HexoとGitHub-Pagesでブログ環境の構築/" title="Hexo と GitHub Pages で ブログ環境の構築" rel="bookmark">Hexo と GitHub Pages で ブログ環境の構築</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/04/17/Google-AnalyticsにSearch-Consoleの分析を追加する/" title="Google Analytics に Search Console の 分析を追加する" rel="bookmark">Google Analytics に Search Console の 分析を追加する</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
    <article id="post-Slackのボットによる代理ポストで、簡易匿名化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/26/Slackのボットによる代理ポストで、簡易匿名化/" class="article-date">
  <time datetime="2016-12-25T15:00:00.000Z" itemprop="datePublished">2016-12-26</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/ボット/">ボット</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2016/12/26/Slackのボットによる代理ポストで、簡易匿名化/">Slack の ボットによる代理ポストで、簡易匿名化</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/slack/slack.png" alt title="Slack"></p>
<p>ようやく常時稼働するボットを Slack に 常駐できるようになりました. 今回は Slack で 匿名発言する方法について考えたいと思います.</p>
<p><strong>作業環境</strong></p>
<ul>
<li>Slack</li>
<li>Node.js 6.9.1 LTS</li>
<li>Botkit 0.4.2</li>
</ul>
<h2 id="Slack-で-匿名発言"><a href="#Slack-で-匿名発言" class="headerlink" title="Slack で 匿名発言"></a>Slack で 匿名発言</h2><p>そもそもチャットなのに、なんで匿名で発言する必要があるのか、といった話もありますが、チームや組織の改善などを忌憚なくディスカスするには匿名はある程度意味があるようです.<br>行き過ぎると匿名のネット掲示板のように荒れるというケースもあるようですが、Slack は 招待性のチームで作られるので、ある程度は自制・自浄されることは期待できそうです.</p>
<p>Slack で 匿名発言する方法ですが、公式でその機能はありません. したがって何らかの仕掛けを作る必要があります.<br>API を 使って発言する方法なども考えられますが、せっかくボットを常駐させたので代理で発言してもらって、匿名化してみたいと思います.</p>
<h2 id="ボット-で-代理発言"><a href="#ボット-で-代理発言" class="headerlink" title="ボット で 代理発言"></a>ボット で 代理発言</h2><p>Slack の ボットは、<a href="/2016/12/17/Slackにボットを設置する/">以前に設置したボット</a> を 使うことにします.<br>ボットへの代理発言依頼は、ダイレクト・メッセージを使うことにします.</p>
<p>匿名で発言する先のチャンネルを選択(or 作成) します. 今回は <code>sandbox</code> に しました.<br>続いて チャンネル の ID を 調べるために、以下の URL へ アクセスします. <code>[API_TOKEN]</code> は ボットの起動に使用している API トークンです.<br><code>https://slack.com/api/channels.list?token=[API_TOKEN]</code></p>
<p>ページへアクセスすると JSON 形式 の チャンネル・リストが表示されるので、目的のチャンネルの ID を コピーします. 以下に今回使用する <code>sandbox</code> の 部分を抜粋します. <code>&quot;id&quot;: &quot;C3ADKXXXX&quot;,</code> の <code>C3ADKXXXX</code> に 当たる部分になります.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ok"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"channels"</span>: [&#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"C3ADKXXXX"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"sandbox"</span>,</span><br><span class="line">        <span class="attr">"is_channel"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"created"</span>: <span class="number">1481422490</span>,</span><br><span class="line">        <span class="attr">"creator"</span>: <span class="string">"U3A3DXXXX"</span>,</span><br><span class="line">        <span class="attr">"is_archived"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"is_general"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"is_member"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"members"</span>: [ <span class="string">"U3A3DXXXX"</span>, U3AQBXXXX ],</span><br><span class="line">        <span class="attr">"topic"</span>: &#123; <span class="attr">"value"</span>: <span class="string">""</span>, <span class="attr">"creator"</span>: <span class="string">""</span>, <span class="attr">"last_set"</span>: <span class="number">0</span> &#125;,</span><br><span class="line">        <span class="attr">"purpose"</span>: &#123; <span class="attr">"value"</span>: <span class="string">""</span>, <span class="attr">"creator"</span>: <span class="string">""</span>, <span class="attr">"last_set"</span>: <span class="number">0</span> &#125;,</span><br><span class="line">        <span class="attr">"num_members"</span>: <span class="number">2</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></table></figure></p>
<p>ボットの代理発言を実装します.<br>以下のコードをボットの実装に追加します. [CHANNEL_ID] は 上記で取得した発言先チャンネル の ID です.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre><td class="code"><pre><span class="line">controller.on(<span class="string">'direct_message'</span>, (bot, message) =&gt; &#123;</span><br><span class="line">    bot.reply(message, <span class="string">'匿名でポストしました.'</span>);</span><br><span class="line">    bot.startConversation(&#123;  <span class="attr">channel</span> : <span class="string">'[CHANNEL_ID]'</span> &#125;, (err, convo) =&gt; &#123;</span><br><span class="line">        convo.say(message);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></table></figure></p>
<p>実装の内容としては以下となります.</p>
<ul>
<li><code>controller.on()</code> で <code>direct_message</code> イベント に 反応するようにします.</li>
<li><code>bot.reply()</code> で ダイレクト・メッセージに返事をします.</li>
<li><code>bot.startConversation()</code> で ID 指定したチャンネルで会話を開始します.</li>
<li><code>convo.say(message);</code> で 指定チャンネルへ <code>message</code>、ユーザから入力された内容を そのままに指定チャンネルへ発言します.</li>
</ul>
<h2 id="匿名で発言！"><a href="#匿名で発言！" class="headerlink" title="匿名で発言！"></a>匿名で発言！</h2><p>DIRECT MESSAGES の ボット名をクリックし、発言したい内容を入力します. (つまりボットに対してダイレクト・メッセージを送ります)<br><img src="/assets/slack/anonymizer/01.png" alt></p>
<p>ダイレクト・メッセージを送るとボットから返事があり、すぐに匿名発言先のチャンネル (ここでは sandbox) に 発言があるハイライトがされます.<br><img src="/assets/slack/anonymizer/02.png" alt></p>
<p>チャンネルを開くと、先ほどボットにダイレクト・メッセージした内容を、ボットが発言しています.<br>匿名発言ができるようになりました.<br><img src="/assets/slack/anonymizer/03.png" alt></p>
<hr>
<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51SYfM4adrL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">はじめてみようSlack 使いこなすための31のヒント</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">Slack研究会 パーソナルメディア 2016-08-03    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01L7HCBT2%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14364488%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>            <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-89-362326-3%2520%257C%25204-893-62326-3%2520%257C%25204-8936-2326-3%2520%257C%25204-89362-326-3%2520%257C%25204-893623-26-3%2520%257C%25204-8936232-6-3" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>

<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51g9K9r7quL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Slack入門 [ChatOpsによるチーム開発の効率化]</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">松下 雅和,小島 泰洋,長瀬 敦史,坂本 卓巳 技術評論社 2016-06-28    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01HI2TD28%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14263497%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>           <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-77-418238-4%2520%257C%25204-774-18238-4%2520%257C%25204-7741-8238-4%2520%257C%25204-77418-238-4%2520%257C%25204-774182-38-4%2520%257C%25204-7741823-8-4" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>



<hr>
<p>ボットを使って匿名発言ができるようになりました. Botkit が いろいろやってくれるので簡単ですね.</p>
<p>ただし匿名とはいえ単にボットで代理発言をさせているだけなので、ボット・プログラムでデバッグログなりを出すことで発言を残すことはできますので、完全匿名とまではいかないですが、自由な発言から議論が広がるといいですね.</p>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2016/12/26/Slackのボットによる代理ポストで、簡易匿名化/" data-id="ckq2rxvb6003q44r2uftvz01u" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Botkit/">Botkit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Slack/">Slack</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/19/Slackのボットで2FA未設定ユーザを監視する-API確認編/" title="Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編" rel="bookmark">Slack の ボット で 2FA(Two-Factor Authentication / 2要素認証) 未設定ユーザ を 監視する - API 確認編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/13/Slackのボットでランダムなカスタム絵文字リアクションをする/" title="Slack の ボット で ランダムなカスタム絵文字リアクション を する" rel="bookmark">Slack の ボット で ランダムなカスタム絵文字リアクション を する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/12/Slackのボットで定時アクション/" title="Slack の ボット で 定時アクション" rel="bookmark">Slack の ボット で 定時アクション</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  
    <article id="post-Slackのボットを自動停止させない" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/23/Slackのボットを自動停止させない/" class="article-date">
  <time datetime="2016-12-22T15:00:00.000Z" itemprop="datePublished">2016-12-23</time>
</a>
      <div class="article-category">
    <a class="article-category-link" href="/categories/ボット/">ボット</a>
  </div>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        <h1 itemprop="name">
      <a class="article-title" href="/2016/12/23/Slackのボットを自動停止させない/">Slack の ボット を 自動停止させない</a>
    </h1>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/assets/slack/slack.png" alt title="Slack"></p>
<p>2017年3月10日 更新<br>Botkit 0.5.1 から<a href="/2017/03/10/Botkitが自動切断されなくなった、みたい/">自動切断されなくなった</a>ようです.<br>本ポストのコードは不要ですが、記録のために残しておきます.</p>
<p><del>Slack に 設置したボット. しばらくするといつの間にかオフラインになっている場合があります…</del><br><del>せっかく作ったボット機能をいつでも簡単に使うというわけにいかないので対策を考えたいと思います.</del></p>
<p><strong>作業環境</strong></p>
<ul>
<li>Slack</li>
<li>Node.js 6.9.1 LTS</li>
<li>Botkit 0.4.2</li>
</ul>
<h2 id="いつの間にかオフライン？"><a href="#いつの間にかオフライン？" class="headerlink" title="いつの間にかオフライン？"></a>いつの間にかオフライン？</h2><p>設置したボットに翌日話しかけてみたところ、応答がありませんでした. 残念…<br>よく見るとオフラインになっています.<br><img src="/assets/slack/bot/down.png" alt></p>
<p>ログを確認したところ <code>notice: RTM close event: 1006 :</code> なる出力があり、その後の再接続に失敗しているようです.<br>起動時と停止時に時間を出力するようにしたところ、約８時間ぐらいで止まっている感じでした. (もしかしたら途中でボットを呼んだから、なんとなく切りよくと考えると６時間？)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre><td class="code"><pre><span class="line">c:\Develop\repos\slack-bot&gt; set token=[API_TOKEN]</span><br><span class="line">c:\Develop\repos\slack-bot&gt; node index.js</span><br><span class="line">Mon Dec 19 2016 15:49:08 GMT+0900 (東京 (標準時))</span><br><span class="line">info: ** No persistent storage method specified! Data may be lost when process shuts down.</span><br><span class="line">info: ** Setting up custom handlers for processing Slack messages</span><br><span class="line">info: ** API CALL: https://slack.com/api/rtm.start</span><br><span class="line">notice: ** BOT ID: bot ...attempting to connect to RTM!</span><br><span class="line">notice: RTM websocket opened</span><br><span class="line">info: ** API CALL: https://slack.com/api/chat.postMessage</span><br><span class="line">notice: RTM close event: 1006 :</span><br><span class="line">Mon Dec 20 2016 07:29:10 GMT+0900 (東京 (標準時))</span><br><span class="line">error: Abnormal websocket close event, attempting to reconnect</span><br><span class="line">notice: ** BOT ID: bot ...reconnect attempt #1 of 3 being made after 1000ms</span><br><span class="line">info: ** API CALL: https://slack.com/api/rtm.start</span><br><span class="line">notice: ** BOT ID: bot ...reconnect attempt #2 of 3 being made after 6297ms</span><br><span class="line">info: ** API CALL: https://slack.com/api/rtm.start</span><br><span class="line">notice: ** BOT ID: bot ...reconnect attempt #3 of 3 being made after 9096ms</span><br><span class="line">info: ** API CALL: https://slack.com/api/rtm.start</span><br><span class="line">error: ** BOT ID: bot ...reconnect failed after #4 attempts and 9096ms</span><br></pre></table></figure></p>
<h2 id="何が起こった？"><a href="#何が起こった？" class="headerlink" title="何が起こった？"></a>何が起こった？</h2><p>ログに <code>RTM close event</code> と あるように、RTM が クローズされたとのこと. これは日付を出力するために <code>rtm_close</code> イベントをフックしているのでわかっている部分で、では何故イベントが発生したのでしょうか.<br><code>rtm_close</code> イベント を 発生させているのは、ログその後のメッセージから <code>Slack_web_api.js</code> の 以下の部分と思われます.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre><td class="code"><pre><span class="line">bot.rtm.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code, message</span>) </span>&#123;</span><br><span class="line">    botkit.log.notice(<span class="string">'RTM close event: '</span> + code + <span class="string">' : '</span> + message);</span><br><span class="line">    <span class="keyword">if</span> (pingTimeoutId) &#123;</span><br><span class="line">        clearTimeout(pingTimeoutId);</span><br><span class="line">    &#125;</span><br><span class="line">    botkit.trigger(<span class="string">'rtm_close'</span>, [bot]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * CLOSE_ABNORMAL error</span></span><br><span class="line"><span class="comment">     * wasn't closed explicitly, should attempt to reconnect</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (code === <span class="number">1006</span>) &#123;</span><br><span class="line">        botkit.log.error(<span class="string">'Abnormal websocket close event, attempting to reconnect'</span>);</span><br><span class="line">        reconnect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></table></figure></p>
<p>そうなると、今度は <code>bot.rtm</code> が <code>close</code> イベントを発火した部分を確認する必要があります.<br>この <code>bot.rtm</code> は <code>bot.rtm = new Ws(res.url, null, {agent: agent});</code> で、<code>var Ws = require(&#39;ws&#39;);</code> です.<br>Node.js の WebSocket ライブラリ <a href="https://github.com/websockets/ws" target="_blank" rel="noopener">ws</a> です. ちょっと深くなってきました…<br>そして、残念ながらクローズの条件となる部分を特定することができませんでした… (技術力足りてない orz)</p>
<h2 id="では、エラー・コード-1006-とは？"><a href="#では、エラー・コード-1006-とは？" class="headerlink" title="では、エラー・コード 1006 とは？"></a>では、エラー・コード 1006 とは？</h2><p>６～８時間放置したら止まったのできっとタイムアウトしたのでしょう. と 思い込むことにして、気を取り直しエラー・コードの <code>1006</code> について調べたいと思います.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre><td class="code"><pre><span class="line">if (code === 1006) &#123;</span><br><span class="line">    botkit.log.error(&apos;Abnormal websocket close event, attempting to reconnect&apos;);</span><br><span class="line">    reconnect();</span><br><span class="line">&#125;</span><br></pre></table></figure></p>
<p><code>Abnormal websocket close event</code> と メッセージが出力されている通り、異常終了した感があります.<br>こちらもコードを追いかけたところ、先の ws の ファイル <code>WebSocket.js</code> に 以下のようなコードがあります.<br>なんか、デフォルト で <code>1006</code> を セットしてメッセージは出さない気がします. ログでも <code>~: 1006 :</code> と <code>1006</code> の　後にメッセージが付きそうなのに何も出てなかったのは、このことなのでしょう. メッセージをつぶすなんて…<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre><td class="code"><pre><span class="line"><span class="comment">// If the connection was closed abnormally (with an error), or if</span></span><br><span class="line"><span class="comment">// the close control frame was not received then the close code</span></span><br><span class="line"><span class="comment">// must default to 1006.</span></span><br><span class="line"><span class="keyword">if</span> (error || !<span class="keyword">this</span>._closeReceived) &#123;</span><br><span class="line">  <span class="keyword">this</span>._closeCode = <span class="number">1006</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.emit(<span class="string">'close'</span>, <span class="keyword">this</span>._closeCode || <span class="number">1000</span>, <span class="keyword">this</span>._closeMessage || <span class="string">''</span>);</span><br></pre></table></figure></p>
<p>しかし、この <code>1006</code> ハードコードもされ、デフォルトで使われ不思議な感じがします.<br>この <code>1006</code> の 謎をたどると <a href="http://stackoverflow.com/questions/19304157/getting-the-reason-why-websockets-closed" target="_blank" rel="noopener">getting the reason why websockets closed - Stack Overflow</a> で 以下のように書かれています.</p>
<blockquote>
<p>Close Code 1006 is a special code that means the connection was closed abnormally (locally) by the browser implementation<br>– <a href="http://stackoverflow.com/questions/19304157/getting-the-reason-why-websockets-closed" target="_blank" rel="noopener">getting the reason why websockets closed - Stack Overflow</a></p>
</blockquote>
<p><code>Close Code 1006</code> だそうで、リンク先を見ると以下のように書かれています.</p>
<blockquote>
<p>7.4.1.  Defined Status Codes<br>     1006 is a reserved value and MUST NOT be set as a status code in a<br>     Close control frame by an endpoint.  It is designated for use in<br>     applications expecting a status code to indicate that the<br>     connection was closed abnormally, e.g., without sending or<br>     receiving a Close control frame.<br>– <a href="https://tools.ietf.org/html/rfc6455#section-7.4.1" target="_blank" rel="noopener">RFC 6455 - The WebSocket Protocol</a></p>
</blockquote>
<p>ちょっと解りにくいので W3C の WebSocket も あたりました.<br>“In all of these cases, the the WebSocket connection close code would be 1006”、全部 <code>1006</code> と 行ってますね… そして上記の RFC 6455 を 見ろと. うーんなるほど.</p>
<blockquote>
<p>User agents must not convey any failure information to scripts in a way that would allow a script to distinguish the following situations:</p>
<ul>
<li>A server whose host name could not be resolved.</li>
<li>A server to which packets could not successfully be routed.</li>
<li>A server that refused the connection on the specified port.</li>
<li>A server that failed to correctly perform a TLS handshake (e.g., the server certificate can’t be verified).</li>
<li>A server that did not complete the opening handshake (e.g. because it was not a WebSocket server).</li>
<li>A WebSocket server that sent a correct opening handshake, but that specified options that caused the client to drop the connection (e.g. the server specified a subprotocol that the client did not offer).</li>
<li>A WebSocket server that abruptly closed the connection after successfully completing the opening handshake.<br>In all of these cases, the the WebSocket connection close code would be 1006, as required by the WebSocket Protocol specification. [WSP]</li>
</ul>
<p>Allowing a script to distinguish these cases would allow a script to probe the user’s local network in preparation for an attack.<br>– <a href="https://www.w3.org/TR/websockets/#feedback-from-the-protocol" target="_blank" rel="noopener">The WebSocket API</a></p>
</blockquote>
<p>攻撃者から守るために全部 <code>1006</code> にしてメッセージも出さないということなのだそうで、詳細を知るにはデバッグしていくしかないので、いったん諦めます…</p>
<h2 id="暫定の対策"><a href="#暫定の対策" class="headerlink" title="暫定の対策"></a>暫定の対策</h2><p>とりあえず止まらないようにワークアラウンドを設定したいと思います.<br>Botkit の GitHub Issues <a href="https://github.com/howdyai/botkit/issues/261" target="_blank" rel="noopener">Slack RTM retry/reconnect not working #261</a>に 同じような話がありワークアラウンドがありました.<br>議論の流れからすると <code>reconnect</code> に 関する <a href="https://github.com/howdyai/botkit/pull/532" target="_blank" rel="noopener">Pull Request #532</a> が 上がっておりマージはされているようですが、そのリリースは 0.4.2 には含まれていないので、将来のバージョンアップに期待しつつ、今は <a href="https://github.com/howdyai/botkit/issues/261#issuecomment-258954201" target="_blank" rel="noopener">@garymoon の コード</a>を 使わせていただきます. ありがとうございます！<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre><td class="code"><pre><span class="line"><span class="keyword">const</span> controller = ...;</span><br><span class="line"><span class="keyword">const</span> bot = ...;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start_rtm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    bot.startRTM(<span class="function">(<span class="params">err,bot,payload</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'Failed to start RTM'</span>)</span><br><span class="line">            <span class="keyword">return</span> setTimeout(start_rtm, <span class="number">60000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"RTM started!"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">controller.on(<span class="string">'rtm_close'</span>, (bot, err) =&gt; &#123;</span><br><span class="line">    start_rtm();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">start_rtm();</span><br></pre></table></figure></p>
<hr>
<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51SYfM4adrL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">はじめてみようSlack 使いこなすための31のヒント</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">Slack研究会 パーソナルメディア 2016-08-03    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4893623265" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01L7HCBT2%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14364488%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>            <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-89-362326-3%2520%257C%25204-893-62326-3%2520%257C%25204-8936-2326-3%2520%257C%25204-89362-326-3%2520%257C%25204-893623-26-3%2520%257C%25204-8936232-6-3" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>

<div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;/zoom:1;overflow:hidden"><div class="booklink-image" style="float:left;margin:0 15px 10px 0"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank"><img src="https://images-fe.ssl-images-amazon.com/images/I/51g9K9r7quL._SL160_.jpg" style="border:none"></a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="booklink-info" style="line-height:120%;/zoom:1;overflow:hidden"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Slack入門 [ChatOpsによるチーム開発の効率化]</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px">松下 雅和,小島 泰洋,長瀬 敦史,坂本 卓巳 技術評論社 2016-06-28    </div><div class="booklink-link2" style="margin-top:10px"><div class="shoplinkamazon" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4774182389" target="_blank">Amazonで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkkindle" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 0 no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860699&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2FB01HI2TD28%2F" target="_blank">Kindleで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=860699&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none"></div><div class="shoplinkrakuten" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -50px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=862013&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F14263497%2F" target="_blank">楽天ブックスで調べる</a><img src="//i.moshimo.com/af/i/impression?a_id=862013&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none"></div>           <div class="shoplinkseven" style="margin-right:5px;background:url(//img.yomereba.com/yl.gif) 0 -100px no-repeat;padding:2px 0 2px 18px;white-space:nowrap"><a href="//af.moshimo.com/af/c/click?a_id=860693&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D4-77-418238-4%2520%257C%25204-774-18238-4%2520%257C%25204-7741-8238-4%2520%257C%25204-77418-238-4%2520%257C%25204-774182-38-4%2520%257C%25204-7741823-8-4" target="_blank">7netで調べる<img src="//i.moshimo.com/af/i/impression?a_id=860693&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none"></a></div>                          </div></div><div class="booklink-footer" style="clear:left"></div></div>



<hr>
<p>これによりノンストップで稼働することができるようになりました. なぜリトライに失敗するのかはデバッグしてかないとわからないので、いずれ確認したいと思いますが、まずはボットに機能を足してボットライフを楽しみましょう♪</p>
      
    </div>
    
      <footer class="article-footer">
        <a data-url="https://azriton.github.io/2016/12/23/Slackのボットを自動停止させない/" data-id="ckq2rxvd2009x44r26rtk8dyo" class="article-share-link">共有</a>
        
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Botkit/">Botkit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Slack/">Slack</a></li></ul>
      </footer>
    
  </div>
  
</article>


  <nav id="related-posts" class="article-inner" style="font-size:smaller">
    <div class="article-entry">
      <h2>関連投稿</h2>
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/02/10/Slackのボットで定期的に降水予報を通知する/" title="Slack の ボット で 定期的に降水予報を通知する" rel="bookmark">Slack の ボット で 定期的に降水予報を通知する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/06/13/Slackのボットでランダムなカスタム絵文字リアクションをする/" title="Slack の ボット で ランダムなカスタム絵文字リアクション を する" rel="bookmark">Slack の ボット で ランダムなカスタム絵文字リアクション を する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/15/SlackのボットでJRA競馬の開催日を通知する-JSON取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - JSON 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/18/SlackのボットでJRA競馬の開催日を通知する-iCalendar取得編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - iCalendar 取得編</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="/2017/01/21/SlackのボットでJRA競馬の開催日を通知する-Slackボット実装編/" title="Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編" rel="bookmark">Slack の ボット で JRA 競馬 の 開催日を通知する - Slack ボット 実装編</a></h3></div></li></ul>
    </div>
  </nav>


<section style="margin:50px 0;text-align:center">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5414788142"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</section>
  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/7/">&laquo; 戻る</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/9/">次へ &raquo;</a>
  </nav></section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title profile">Profile</h3>
  <div class="widget profile">
    <div><img src="/assets/profile.jpg"></div>
    <div class="outline">
      <strong>Azriton</strong> (<code>@azriton</code>) <br>
      IT エンジニア に なりたかった、ただの何でも屋、いや ただの酒呑み. 日本酒 バーボン ビール に アブサン 焼酎 どぶろく テキーラ なんでも来いっす. <br>
    </div>
    <div class="links">
      <a href="https://twitter.com/azriton" class="widget-profile-link-twitter" target="_blank" title="Twitter @azriton"></a>
      <a href="https://github.com/azriton" class="widget-profile-link-github" target="_blank" title="GitHub @azriton"></a>
      <a href="/atom.xml" class="widget-profile-link-atom" target="_blank" title="RSS/Atom"></a>
      <span class="separator">|</span>
      <a href="/pages/about.html" class="widget-profile-link-about" title="このサイトについて"></a>
      <a href="/pages/pp.html" class="widget-profile-link-pp" title="プライバシーポリシー"></a>
    </div>
  </div>
</div>
  
    <div class="widget-wrap">
    <h3 class="widget-title category">カテゴリ</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ブログ/">ブログ</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/プレゼン/">プレゼン</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ボット/">ボット</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/勉強会/">勉強会</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/書籍/">書籍</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/開発環境/">開発環境</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/雑記/">雑記</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/電子工作/">電子工作</a><span class="category-list-count">22</span></li></ul>
    </div>
  </div>
  
    <div class="widget-wrap">
    <h3 class="widget-title tag">タグ</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Botkit/">Botkit</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CircleCI/">CircleCI</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crystal-Signal-Pi/">Crystal Signal Pi</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Disqus/">Disqus</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Eclipse/">Eclipse</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/">GitHub</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google-AIY/">Google AIY</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">21</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/">Node.js</a><span class="tag-list-count">27</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Raspberry-Pi/">Raspberry Pi</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Raspbian/">Raspbian</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Slack/">Slack</a><span class="tag-list-count">24</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Twitter/">Twitter</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/">TypeScript</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Visual-Studio-Code/">Visual Studio Code</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reveal-js/">reveal.js</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>
  
    <div class="widget-wrap">
    <h3 class="widget-title tagcloud">タグクラウド</h3>
    <div class="widget tagcloud">
      <a href="/tags/Git/" style="font-size:13.33px">Git</a> <a href="/tags/Windows/" style="font-size:10.83px">Windows</a> <a href="/tags/Visual-Studio-Code/" style="font-size:14.17px">Visual Studio Code</a> <a href="/tags/Node-js/" style="font-size:20px">Node.js</a> <a href="/tags/reveal-js/" style="font-size:10px">reveal.js</a> <a href="/tags/TypeScript/" style="font-size:12.5px">TypeScript</a> <a href="/tags/Slack/" style="font-size:19.17px">Slack</a> <a href="/tags/Python/" style="font-size:10px">Python</a> <a href="/tags/Raspbian/" style="font-size:15.83px">Raspbian</a> <a href="/tags/Twitter/" style="font-size:11.67px">Twitter</a> <a href="/tags/Eclipse/" style="font-size:14.17px">Eclipse</a> <a href="/tags/Raspberry-Pi/" style="font-size:18.33px">Raspberry Pi</a> <a href="/tags/Disqus/" style="font-size:10.83px">Disqus</a> <a href="/tags/Google-AIY/" style="font-size:11.67px">Google AIY</a> <a href="/tags/Botkit/" style="font-size:17.5px">Botkit</a> <a href="/tags/CircleCI/" style="font-size:11.67px">CircleCI</a> <a href="/tags/Crystal-Signal-Pi/" style="font-size:11.67px">Crystal Signal Pi</a> <a href="/tags/JavaScript/" style="font-size:17.5px">JavaScript</a> <a href="/tags/Hexo/" style="font-size:16.67px">Hexo</a> <a href="/tags/GitHub/" style="font-size:15px">GitHub</a>
    </div>
  </div>
  
    <div class="widget-wrap">
    <h3 class="widget-title recent">最近の投稿</h3>
    <div class="widget">
      <ul class="recent-list">
        
          <li>
            <a href="/2017/12/18/Visual-Studio-Codeでgitが見つからないと言われた場合の対処/">Visual Studio Code で git.exe が 見つからないと言われた場合の対処</a>
          </li>
        
          <li>
            <a href="/2017/12/13/ラズパイの簡易スマート・スピーカーGoogle-AIYでVoice-Recognizerを作る/">ラズパイ の 簡易スマート・スピーカー Google AIY で Voice Recognizer を 作る</a>
          </li>
        
          <li>
            <a href="/2017/12/07/2017年に買ってよかったもの！/">2017年 に 買ってよかったもの！</a>
          </li>
        
          <li>
            <a href="/2017/11/25/Windowsのプロキシを自動設定するタスクを作成/">Windows の プロキシ を 自動設定するタスクを作成</a>
          </li>
        
          <li>
            <a href="/2017/11/15/ラズパイの簡易スマート・スピーカーGoogle-AIYの初期セットアップ/">ラズパイ の 簡易スマート・スピーカー Google AIY の 初期セットアップ</a>
          </li>
        
      </ul>
    </div>
  </div>
  
    <div class="widget-wrap">
    <h3 class="widget-title archive">アーカイブ</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">12月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">11月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">10月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">9月 2017</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">8月 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">7月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">6月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">5月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">4月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">3月 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">2月 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">1月 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">12月 2016</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">11月 2016</a><span class="archive-list-count">9</span></li></ul>
    </div>
  </div>
  
    <div class="widget-wrap">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle" style="display:inline-block;width:300px;height:600px" data-ad-client="ca-pub-4479317936085716" data-ad-slot="5642018856"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>
  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Azriton
      <a href="https://twitter.com/azriton" class="article-link-twitter" target="_blank" title="Twitter @azriton"></a>
      <a href="https://github.com/azriton" class="article-link-github" target="_blank" title="GitHub @azriton"></a>
      <br>
      投稿内容／発言／見解／酒癖／時報 は、私的なものであり、所属している企業や組織には関係ありません.
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
</nav>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>

